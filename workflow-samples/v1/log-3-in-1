localhost:~# docker run -it \
>     -e "DOCKER_API_VERSION=v1.35" \
>     -e "WORKER_ID=fde7c87c-d154-447e-9fce-7eb7bdec90c0" \
>     -e "DOCKER_REGISTRY=192.168.1.1" \
>     -e "ROVER_GRPC_AUTHORITY=192.168.1.1:42113" \
>     -e "ROVER_CERT_URL=http://192.168.1.1:42114/cert" \
>     -e "REGISTRY_USERNAME=packetadmin" \
>     -e "REGISTRY_PASSWORD=P@ck3tR0cks!" \
>     -v /var/run/docker.sock:/var/run/docker.sock \
>     -v /worker:/worker \
> -v /etc/docker/cert.d/192.168.1.1:/192.168.1.1 \
> 192.168.1.1/worker
^[[6;3RINFO[0000] RETRY_INTERVAL not set. Using default, 3 seconds 
INFO[0000] MAX_RETRY not set. Using default, 3 retries. 
INFO[0000] Fetching latest context for worker fde7c87c-d154-447e-9fce-7eb7bdec90c0  worker_id=fde7c87c-d154-447e-9fce-7eb7bdec90c0
ERRO[0000] Variable WORKER_LOG_LEVEL is not set. Default is Info 
{"level":"info","msg":"Starting with action task_name:\"os-installation\" name:\"disk-wipe\" image:\"disk-wipe\" timeout:90 worker_id:\"fde7c87c-d154-447e-9fce-7eb7bdec90c0\" volumes:\"/worker:/worker\" volumes:\"/mnt:/mnt\" volumes:\"/dev:/dev\" volumes:\"/dev/console:/dev/console\" volumes:\"/lib/firmware:/lib/firmware:ro\" \n","time":"2020-02-11T04:45:58Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0"}
{"action_name":"disk-wipe","level":"info","msg":"Sent action status  ACTION_IN_PROGRESS","time":"2020-02-11T04:45:58Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0"}
{"status":"Pulling from disk-wipe","id":"latest"}
{"status":"Digest: sha256:47bcbe64a2b6681296add6d9963c7c26e8404e76c412aeb6ac93a456c2ef46cc"}
{"status":"Status: Image is up to date for 192.168.1.1/disk-wipe:latest"}
{"level":"info","msg":"Starting the container with cmd []","time":"2020-02-11T04:45:58Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
+ set -o nounset
@+ disks=($(lsblk -dno name -e1,7,11 | sed 's|^|/dev/|' | sort))
++ lsblk -dno name -e1,7,11
++ sed 's|^|/dev/|'
++ sort

 ++ date +%s
+ stimer=1581396358
7+ mdarrays=($(awk '/md/ {print $4}' /proc/partitions))
*++ awk '/md/ {print $4}' /proc/partitions
+ (( 0 != 0 ))
+ for bd in '"${disks[@]}"'
+ for bd in '"${disks[@]}"'
+ sgdisk -Z /dev/sda
+ for bd in '"${disks[@]}"'
+ sgdisk -Z /dev/sdb
+ for bd in '"${disks[@]}"'
+ sgdisk -Z /dev/sdc
+ sgdisk -Z /dev/sdd
+ for bd in '"${disks[@]}"'

+ wait -n
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ [[ -d /sys/firmware/efi ]]
++ efibootmgr
;++ sed -n '/^Boot[0-9A-F]/ s|Boot\([0-9A-F]\{4\}\).*|\1|p'
<efibootmgr: EFI variables are not supported on this system.
Disk wipe finished.
+ echo 'Disk wipe finished.'

 ++ date +%s
+ etimer=1581396359
/+ echo -e '\033[0;33;5;7mClean time: 1\033[0m'
Clean time: 1
{"level":"info","msg":"Container with id  3e32b24a22f31d553737401a1d3dbfe1904b166198805a2a23aa22d18a8ffbf6 finished with status code :  0","time":"2020-02-11T04:45:59Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ [[ -d /sys/firmware/efi ]]
++ efibootmgr
;++ sed -n '/^Boot[0-9A-F]/ s|Boot\([0-9A-F]\{4\}\).*|\1|p'
<efibootmgr: EFI variables are not supported on this system.
Disk wipe finished.
+ echo 'Disk wipe finished.'

 ++ date +%s
+ etimer=1581396359
/+ echo -e '\033[0;33;5;7mClean time: 1\033[0m'
Clean time: 1
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ for bd in '"${disks[@]}"'

+ wait -n
Creating new GPT entries.
MGPT data structures destroyed! You may now partition the disk using fdisk or
other utilities.
+ [[ -d /sys/firmware/efi ]]
++ efibootmgr
;++ sed -n '/^Boot[0-9A-F]/ s|Boot\([0-9A-F]\{4\}\).*|\1|p'
<efibootmgr: EFI variables are not supported on this system.
Disk wipe finished.
+ echo 'Disk wipe finished.'

 ++ date +%s
+ etimer=1581396359
/+ echo -e '\033[0;33;5;7mClean time: 1\033[0m'
Clean time: 1
{"level":"info","msg":"Container removed with Status  ACTION_SUCCESS","time":"2020-02-11T04:45:59Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"level":"info","msg":"Action container exits with status code  ACTION_SUCCESS","time":"2020-02-11T04:45:59Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"level":"info","msg":"Sent action status workflow_id:\"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91\" task_name:\"os-installation\" action_name:\"disk-wipe\" action_status:ACTION_SUCCESS seconds:1 message:\"Finished Execution Successfully\" worker_id:\"fde7c87c-d154-447e-9fce-7eb7bdec90c0\" \n","time":"2020-02-11T04:45:59Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"action_name":"fetch-assets","level":"info","msg":"Sent action status  ACTION_IN_PROGRESS","time":"2020-02-11T04:45:59Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"status":"Pulling from fetch-assets","id":"latest"}
{"status":"Already exists","progressDetail":{},"id":"0a01a72a686c"}
{"status":"Already exists","progressDetail":{},"id":"cc899a5544da"}
{"status":"Already exists","progressDetail":{},"id":"19197c550755"}
{"status":"Already exists","progressDetail":{},"id":"716d454e56b6"}
{"status":"Already exists","progressDetail":{},"id":"2c0f403b937f"}
{"status":"Already exists","progressDetail":{},"id":"757c0ee525f8"}
{"status":"Already exists","progressDetail":{},"id":"88e669c5c0a9"}
{"status":"Already exists","progressDetail":{},"id":"398160ccbc08"}
{"status":"Already exists","progressDetail":{},"id":"4b30a4963a8a"}
{"status":"Pulling fs layer","progressDetail":{},"id":"eb38adee6edf"}
{"status":"Pulling fs layer","progressDetail":{},"id":"101bc484189a"}
{"status":"Pulling fs layer","progressDetail":{},"id":"c565e78fc7c7"}
{"status":"Pulling fs layer","progressDetail":{},"id":"87e498916cc4"}
{"status":"Pulling fs layer","progressDetail":{},"id":"5dabab4f7f1a"}
{"status":"Pulling fs layer","progressDetail":{},"id":"e58590b4f161"}
{"status":"Pulling fs layer","progressDetail":{},"id":"73c8c4d87988"}
{"status":"Pulling fs layer","progressDetail":{},"id":"6169e99942ba"}
{"status":"Pulling fs layer","progressDetail":{},"id":"df2c4f705e28"}
{"status":"Pulling fs layer","progressDetail":{},"id":"59630d345aab"}
{"status":"Waiting","progressDetail":{},"id":"e58590b4f161"}
{"status":"Waiting","progressDetail":{},"id":"73c8c4d87988"}
{"status":"Waiting","progressDetail":{},"id":"5dabab4f7f1a"}
{"status":"Waiting","progressDetail":{},"id":"87e498916cc4"}
{"status":"Waiting","progressDetail":{},"id":"df2c4f705e28"}
{"status":"Waiting","progressDetail":{},"id":"59630d345aab"}
{"status":"Downloading","progressDetail":{"current":79684,"total":7929821},"progress":"[\u003e                                                  ]  79.68kB/7.93MB","id":"eb38adee6edf"}
{"status":"Downloading","progressDetail":{"current":393216,"total":38823812},"progress":"[\u003e                                                  ]  393.2kB/38.82MB","id":"101bc484189a"}
{"status":"Downloading","progressDetail":{"current":540672,"total":64963445},"progress":"[\u003e                                                  ]  540.7kB/64.96MB","id":"c565e78fc7c7"}
{"status":"Verifying Checksum","progressDetail":{},"id":"eb38adee6edf"}
{"status":"Download complete","progressDetail":{},"id":"eb38adee6edf"}
{"status":"Extracting","progressDetail":{"current":98304,"total":7929821},"progress":"[\u003e                                                  ]   98.3kB/7.93MB","id":"eb38adee6edf"}
{"status":"Downloading","progressDetail":{"current":540672,"total":439264929},"progress":"[\u003e                                                  ]  540.7kB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":20840448,"total":38823812},"progress":"[==========================\u003e                        ]  20.84MB/38.82MB","id":"101bc484189a"}
{"status":"Downloading","progressDetail":{"current":20545536,"total":64963445},"progress":"[===============\u003e                                   ]  20.55MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Extracting","progressDetail":{"current":6094848,"total":7929821},"progress":"[======================================\u003e            ]  6.095MB/7.93MB","id":"eb38adee6edf"}
{"status":"Extracting","progressDetail":{"current":7929821,"total":7929821},"progress":"[==================================================\u003e]   7.93MB/7.93MB","id":"eb38adee6edf"}
{"status":"Downloading","progressDetail":{"current":19464192,"total":439264929},"progress":"[==\u003e                                                ]  19.46MB/439.3MB","id":"87e498916cc4"}
{"status":"Pull complete","progressDetail":{},"id":"eb38adee6edf"}
{"status":"Verifying Checksum","progressDetail":{},"id":"101bc484189a"}
{"status":"Download complete","progressDetail":{},"id":"101bc484189a"}
{"status":"Downloading","progressDetail":{"current":730,"total":2345},"progress":"[===============\u003e                                   ]     730B/2.345kB","id":"5dabab4f7f1a"}
{"status":"Downloading","progressDetail":{"current":2345,"total":2345},"progress":"[==================================================\u003e]  2.345kB/2.345kB","id":"5dabab4f7f1a"}
{"status":"Verifying Checksum","progressDetail":{},"id":"5dabab4f7f1a"}
{"status":"Download complete","progressDetail":{},"id":"5dabab4f7f1a"}
{"status":"Downloading","progressDetail":{"current":40009728,"total":64963445},"progress":"[==============================\u003e                    ]  40.01MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":226,"total":226},"progress":"[==================================================\u003e]     226B/226B","id":"e58590b4f161"}
{"status":"Verifying Checksum","progressDetail":{},"id":"e58590b4f161"}
{"status":"Download complete","progressDetail":{},"id":"e58590b4f161"}
{"status":"Downloading","progressDetail":{"current":730,"total":1930},"progress":"[==================\u003e                                ]     730B/1.93kB","id":"73c8c4d87988"}
{"status":"Downloading","progressDetail":{"current":1930,"total":1930},"progress":"[==================================================\u003e]   1.93kB/1.93kB","id":"73c8c4d87988"}
{"status":"Verifying Checksum","progressDetail":{},"id":"73c8c4d87988"}
{"status":"Download complete","progressDetail":{},"id":"73c8c4d87988"}
{"status":"Downloading","progressDetail":{"current":730,"total":2478},"progress":"[==============\u003e                                    ]     730B/2.478kB","id":"6169e99942ba"}
{"status":"Downloading","progressDetail":{"current":2478,"total":2478},"progress":"[==================================================\u003e]  2.478kB/2.478kB","id":"6169e99942ba"}
{"status":"Verifying Checksum","progressDetail":{},"id":"6169e99942ba"}
{"status":"Download complete","progressDetail":{},"id":"6169e99942ba"}
{"status":"Downloading","progressDetail":{"current":730,"total":1660},"progress":"[=====================\u003e                             ]     730B/1.66kB","id":"df2c4f705e28"}
{"status":"Downloading","progressDetail":{"current":1660,"total":1660},"progress":"[==================================================\u003e]   1.66kB/1.66kB","id":"df2c4f705e28"}
{"status":"Verifying Checksum","progressDetail":{},"id":"df2c4f705e28"}
{"status":"Download complete","progressDetail":{},"id":"df2c4f705e28"}
{"status":"Downloading","progressDetail":{"current":40009728,"total":439264929},"progress":"[====\u003e                                              ]  40.01MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":730,"total":4895},"progress":"[=======\u003e                                           ]     730B/4.895kB","id":"59630d345aab"}
{"status":"Downloading","progressDetail":{"current":4895,"total":4895},"progress":"[==================================================\u003e]  4.895kB/4.895kB","id":"59630d345aab"}
{"status":"Verifying Checksum","progressDetail":{},"id":"59630d345aab"}
{"status":"Download complete","progressDetail":{},"id":"59630d345aab"}
{"status":"Extracting","progressDetail":{"current":393216,"total":38823812},"progress":"[\u003e                                                  ]  393.2kB/38.82MB","id":"101bc484189a"}
{"status":"Downloading","progressDetail":{"current":60555264,"total":64963445},"progress":"[==============================================\u003e    ]  60.56MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Verifying Checksum","progressDetail":{},"id":"c565e78fc7c7"}
{"status":"Download complete","progressDetail":{},"id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":58933248,"total":439264929},"progress":"[======\u003e                                            ]  58.93MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":17301504,"total":38823812},"progress":"[======================\u003e                            ]   17.3MB/38.82MB","id":"101bc484189a"}
{"status":"Downloading","progressDetail":{"current":77856768,"total":439264929},"progress":"[========\u003e                                          ]  77.86MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":36569088,"total":38823812},"progress":"[===============================================\u003e   ]  36.57MB/38.82MB","id":"101bc484189a"}
{"status":"Extracting","progressDetail":{"current":38823812,"total":38823812},"progress":"[==================================================\u003e]  38.82MB/38.82MB","id":"101bc484189a"}
{"status":"Pull complete","progressDetail":{},"id":"101bc484189a"}
{"status":"Downloading","progressDetail":{"current":98402304,"total":439264929},"progress":"[===========\u003e                                       ]   98.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":557056,"total":64963445},"progress":"[\u003e                                                  ]  557.1kB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":118407168,"total":439264929},"progress":"[=============\u003e                                     ]  118.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":8355840,"total":64963445},"progress":"[======\u003e                                            ]  8.356MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":138412032,"total":439264929},"progress":"[===============\u003e                                   ]  138.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":14483456,"total":64963445},"progress":"[===========\u003e                                       ]  14.48MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":158416896,"total":439264929},"progress":"[==================\u003e                                ]  158.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":21725184,"total":64963445},"progress":"[================\u003e                                  ]  21.73MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":178421760,"total":439264929},"progress":"[====================\u003e                              ]  178.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":28966912,"total":64963445},"progress":"[======================\u003e                            ]  28.97MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":198426624,"total":439264929},"progress":"[======================\u003e                            ]  198.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":35651584,"total":64963445},"progress":"[===========================\u003e                       ]  35.65MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":217890816,"total":439264929},"progress":"[========================\u003e                          ]  217.9MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":43450368,"total":64963445},"progress":"[=================================\u003e                 ]  43.45MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":237355008,"total":439264929},"progress":"[===========================\u003e                       ]  237.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":52363264,"total":64963445},"progress":"[========================================\u003e          ]  52.36MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":257900544,"total":439264929},"progress":"[=============================\u003e                     ]  257.9MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":59604992,"total":64963445},"progress":"[=============================================\u003e     ]   59.6MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":277364736,"total":439264929},"progress":"[===============================\u003e                   ]  277.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":64963445,"total":64963445},"progress":"[==================================================\u003e]  64.96MB/64.96MB","id":"c565e78fc7c7"}
{"status":"Pull complete","progressDetail":{},"id":"c565e78fc7c7"}
{"status":"Downloading","progressDetail":{"current":297369600,"total":439264929},"progress":"[=================================\u003e                 ]  297.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":317915136,"total":439264929},"progress":"[====================================\u003e              ]  317.9MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":337920000,"total":439264929},"progress":"[======================================\u003e            ]  337.9MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":358465536,"total":439264929},"progress":"[========================================\u003e          ]  358.5MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":379011072,"total":439264929},"progress":"[===========================================\u003e       ]    379MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":399556608,"total":439264929},"progress":"[=============================================\u003e     ]  399.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Downloading","progressDetail":{"current":419561472,"total":439264929},"progress":"[===============================================\u003e   ]  419.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Download complete","progressDetail":{},"id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":557056,"total":439264929},"progress":"[\u003e                                                  ]  557.1kB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":12812288,"total":439264929},"progress":"[=\u003e                                                 ]  12.81MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":25624576,"total":439264929},"progress":"[==\u003e                                                ]  25.62MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":34537472,"total":439264929},"progress":"[===\u003e                                               ]  34.54MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":44564480,"total":439264929},"progress":"[=====\u003e                                             ]  44.56MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":57376768,"total":439264929},"progress":"[======\u003e                                            ]  57.38MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":70189056,"total":439264929},"progress":"[=======\u003e                                           ]  70.19MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":81887232,"total":439264929},"progress":"[=========\u003e                                         ]  81.89MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":92471296,"total":439264929},"progress":"[==========\u003e                                        ]  92.47MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":106397696,"total":439264929},"progress":"[============\u003e                                      ]  106.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":116981760,"total":439264929},"progress":"[=============\u003e                                     ]    117MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":127565824,"total":439264929},"progress":"[==============\u003e                                    ]  127.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":137592832,"total":439264929},"progress":"[===============\u003e                                   ]  137.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":145391616,"total":439264929},"progress":"[================\u003e                                  ]  145.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":149848064,"total":439264929},"progress":"[=================\u003e                                 ]  149.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":158760960,"total":439264929},"progress":"[==================\u003e                                ]  158.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":168230912,"total":439264929},"progress":"[===================\u003e                               ]  168.2MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":176586752,"total":439264929},"progress":"[====================\u003e                              ]  176.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":184385536,"total":439264929},"progress":"[====================\u003e                              ]  184.4MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":192741376,"total":439264929},"progress":"[=====================\u003e                             ]  192.7MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":200540160,"total":439264929},"progress":"[======================\u003e                            ]  200.5MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":209453056,"total":439264929},"progress":"[=======================\u003e                           ]  209.5MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":217808896,"total":439264929},"progress":"[========================\u003e                          ]  217.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":224493568,"total":439264929},"progress":"[=========================\u003e                         ]  224.5MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":232849408,"total":439264929},"progress":"[==========================\u003e                        ]  232.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":242319360,"total":439264929},"progress":"[===========================\u003e                       ]  242.3MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":251232256,"total":439264929},"progress":"[============================\u003e                      ]  251.2MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":259588096,"total":439264929},"progress":"[=============================\u003e                     ]  259.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":269615104,"total":439264929},"progress":"[==============================\u003e                    ]  269.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":275742720,"total":439264929},"progress":"[===============================\u003e                   ]  275.7MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":284098560,"total":439264929},"progress":"[================================\u003e                  ]  284.1MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":293011456,"total":439264929},"progress":"[=================================\u003e                 ]    293MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":304152576,"total":439264929},"progress":"[==================================\u003e                ]  304.2MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":313065472,"total":439264929},"progress":"[===================================\u003e               ]  313.1MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":321978368,"total":439264929},"progress":"[====================================\u003e              ]    322MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":332005376,"total":439264929},"progress":"[=====================================\u003e             ]    332MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":340918272,"total":439264929},"progress":"[======================================\u003e            ]  340.9MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":351502336,"total":439264929},"progress":"[========================================\u003e          ]  351.5MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":363757568,"total":439264929},"progress":"[=========================================\u003e         ]  363.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":373784576,"total":439264929},"progress":"[==========================================\u003e        ]  373.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":383811584,"total":439264929},"progress":"[===========================================\u003e       ]  383.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":401637376,"total":439264929},"progress":"[=============================================\u003e     ]  401.6MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":422248448,"total":439264929},"progress":"[================================================\u003e  ]  422.2MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":437846016,"total":439264929},"progress":"[=================================================\u003e ]  437.8MB/439.3MB","id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":439264929,"total":439264929},"progress":"[==================================================\u003e]  439.3MB/439.3MB","id":"87e498916cc4"}
{"status":"Pull complete","progressDetail":{},"id":"87e498916cc4"}
{"status":"Extracting","progressDetail":{"current":2345,"total":2345},"progress":"[==================================================\u003e]  2.345kB/2.345kB","id":"5dabab4f7f1a"}
{"status":"Extracting","progressDetail":{"current":2345,"total":2345},"progress":"[==================================================\u003e]  2.345kB/2.345kB","id":"5dabab4f7f1a"}
{"status":"Pull complete","progressDetail":{},"id":"5dabab4f7f1a"}
{"status":"Extracting","progressDetail":{"current":226,"total":226},"progress":"[==================================================\u003e]     226B/226B","id":"e58590b4f161"}
{"status":"Extracting","progressDetail":{"current":226,"total":226},"progress":"[==================================================\u003e]     226B/226B","id":"e58590b4f161"}
{"status":"Pull complete","progressDetail":{},"id":"e58590b4f161"}
{"status":"Extracting","progressDetail":{"current":1930,"total":1930},"progress":"[==================================================\u003e]   1.93kB/1.93kB","id":"73c8c4d87988"}
{"status":"Extracting","progressDetail":{"current":1930,"total":1930},"progress":"[==================================================\u003e]   1.93kB/1.93kB","id":"73c8c4d87988"}
{"status":"Pull complete","progressDetail":{},"id":"73c8c4d87988"}
{"status":"Extracting","progressDetail":{"current":2478,"total":2478},"progress":"[==================================================\u003e]  2.478kB/2.478kB","id":"6169e99942ba"}
{"status":"Extracting","progressDetail":{"current":2478,"total":2478},"progress":"[==================================================\u003e]  2.478kB/2.478kB","id":"6169e99942ba"}
{"status":"Pull complete","progressDetail":{},"id":"6169e99942ba"}
{"status":"Extracting","progressDetail":{"current":1660,"total":1660},"progress":"[==================================================\u003e]   1.66kB/1.66kB","id":"df2c4f705e28"}
{"status":"Extracting","progressDetail":{"current":1660,"total":1660},"progress":"[==================================================\u003e]   1.66kB/1.66kB","id":"df2c4f705e28"}
{"status":"Pull complete","progressDetail":{},"id":"df2c4f705e28"}
{"status":"Extracting","progressDetail":{"current":4895,"total":4895},"progress":"[==================================================\u003e]  4.895kB/4.895kB","id":"59630d345aab"}
{"status":"Extracting","progressDetail":{"current":4895,"total":4895},"progress":"[==================================================\u003e]  4.895kB/4.895kB","id":"59630d345aab"}
{"status":"Pull complete","progressDetail":{},"id":"59630d345aab"}
{"status":"Digest: sha256:44352f2974f4f945c84a5d98492f3dfb0c7c8512da261e44a5ba3ccbb5d95e26"}
{"status":"Status: Downloaded newer image for 192.168.1.1/fetch-assets:latest"}
{"level":"info","msg":"Starting the container with cmd []","time":"2020-02-11T04:46:07Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
+ set -o nounset
+ metadata=/metadata
F+ curl -sSL --connect-timeout 60 https://metadata.packet.net/metadata
@+ disks=($(lsblk -dno name -e1,7,11 | sed 's|^|/dev/|' | sort))
++ lsblk -dno name -e1,7,11
++ sed 's|^|/dev/|'
++ sort
+ userdata=/dev/null

 ++ uname -m
+ arch=x86_64
2+ check_required_arg /metadata 'metadata file' -M
+ arg=/metadata
+ name='metadata file'

 + switch=-M
+ [[ -n /metadata ]]

 + return 0
+ declare class
 + set_from_metadata class class
+ local var=class key=class

 + local val
+++ jq -r 'select(.class != null) | .class'
+ val=c2.medium.x86
+ [[ -z c2.medium.x86 ]]
!+ declare -g class=c2.medium.x86
+ declare facility
&+ set_from_metadata facility facility
"+ local var=facility key=facility

 + local val
1++ jq -r 'select(.facility != null) | .facility'

 + val=ewr1
+ [[ -z ewr1 ]]
+ declare -g facility=ewr1
+ declare os
-+ set_from_metadata os operating_system.slug
)+ local var=os key=operating_system.slug

 + local val
K++ jq -r 'select(.operating_system.slug != null) | .operating_system.slug'
+ val=ubuntu_18_04
+ [[ -z ubuntu_18_04 ]]
+ declare -g os=ubuntu_18_04
+ declare preserve_data
6+ set_from_metadata preserve_data preserve_data false
,+ local var=preserve_data key=preserve_data

 + local val
;++ jq -r 'select(.preserve_data != null) | .preserve_data'
+ val=
+ [[ -z '' ]]
1+ echo 'preserve_data is missing, empty or null'
(preserve_data is missing, empty or null
+ [[ -z false ]]
0+ echo 'using default value  for preserve_data'
'using default value  for preserve_data

 + val=false
!+ declare -g preserve_data=false
2+ declare pwhash=5f4dcc3b5aa765d61d8327deb882cf99
+ declare tag
3+ set_from_metadata tag operating_system.image_tag
/+ local var=tag key=operating_system.image_tag

 + local val
U++ jq -r 'select(.operating_system.image_tag != null) | .operating_system.image_tag'
/+ val=f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6
4+ [[ -z f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6 ]]
:+ declare -g tag=f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6
+ declare tinkerbell
.+ set_from_metadata tinkerbell phone_home_url
*+ local var=tinkerbell key=phone_home_url

 + local val
=++ jq -r 'select(.phone_home_url != null) | .phone_home_url'
3+ val=http://tinkerbell.ewr1.packet.net/phone-home
8+ [[ -z http://tinkerbell.ewr1.packet.net/phone-home ]]
E+ declare -g tinkerbell=http://tinkerbell.ewr1.packet.net/phone-home
+ declare deprovision_fast
<+ set_from_metadata deprovision_fast deprovision_fast false
2+ local var=deprovision_fast key=deprovision_fast

 + local val
A++ jq -r 'select(.deprovision_fast != null) | .deprovision_fast'
+ val=
+ [[ -z '' ]]
4+ echo 'deprovision_fast is missing, empty or null'
+deprovision_fast is missing, empty or null
+ [[ -z false ]]
3+ echo 'using default value  for deprovision_fast'
*using default value  for deprovision_fast

 + val=false
$+ declare -g deprovision_fast=false
;+ OS=ubuntu_18_04:f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6
#+ echo 'Number of drives found: 4'
Number of drives found: 4
 Disk candidate check successful
+ (( 4 != 0 ))
)+ echo 'Disk candidate check successful'
+ custom_image=false
+ target=/mnt/target
+ cprconfig=/tmp/config.cpr
+ cprout=/statedir/cpr.json
+ mkdir -p /statedir
+ touch /statedir/cpr.json
J+ echo -e '\033[0;32m#### Checking userdata for custom cpr_url...\033[0m'
8#### Checking userdata for custom cpr_url...
2++ sed -nr 's|.*\bcpr_url=(\S+).*|\1|p' /dev/null

 + cpr_url=
+ [[ -z '' ]]
7+ echo 'Using default image since no cpr_url provided'
.Using default image since no cpr_url provided
+ jq -c .storage /metadata

 ++ date +%s
+ stimer=1581396367
5+ [[ -f /statedir/disks-partioned-image-extracted ]]
+ assetdir=/tmp/assets
3#### Fetching image (and more) via git 
E+ echo -e '\033[0;32m#### Fetching image (and more) via git \033[0m'
+ githost=images.packet.net
"++ getent hosts images.packet.net
++ awk '{print $1}'
+ images_ip=147.75.40.4
"+ cp -a /etc/hosts /etc/hosts.new
:+ echo '147.75.40.4        github-cloud.s3.amazonaws.com'
"+ cp -f /etc/hosts.new /etc/hosts
H+ echo -n 'LFS pulls via github-cloud will now resolve to image cache:'
-+ getent hosts github-cloud.s3.amazonaws.com
+ awk '{print $1}'
GLFS pulls via github-cloud will now resolve to image cache:147.75.40.4
C+ [[ ubuntu_18_04:f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6 =~ : ]]
+ [[ false == false ]]
>++ echo ubuntu_18_04:f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6
++ awk -F: '{print $2}'
5+ image_tag=f8ed0b0456a92b125657e5b64e35a4e5b0cdbcd6
'+ gitpath=packethost/packet-images.git
@+ gituri=https://images.packet.net/packethost/packet-images.git
++ git config --global http.sslverify false
+ OS=ubuntu_18_04
#+ kernel=/tmp/assets/kernel.tar.gz
#+ initrd=/tmp/assets/initrd.tar.gz
%+ modules=/tmp/assets/modules.tar.gz
!+ image=/tmp/assets/image.tar.gz
/+ BASEURL=http://192.168.1.2/misc/osie/current
Z+ grub=http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template
=+ echo -e '\033[0;37mImage: /tmp/assets/image.tar.gz\033[0m'
+Image: /tmp/assets/image.tar.gz
A+ echo -e '\033[0;37mModules: /tmp/assets/modules.tar.gz\033[0m'
?+ echo -e '\033[0;37mKernel: /tmp/assets/kernel.tar.gz\033[0m'
/Modules: /tmp/assets/modules.tar.gz
-Kernel: /tmp/assets/kernel.tar.gz
?+ echo -e '\033[0;37mInitrd: /tmp/assets/initrd.tar.gz\033[0m'
-Initrd: /tmp/assets/initrd.tar.gz
I+ echo -e '\033[0;37mDevices:/dev/sda /dev/sdb /dev/sdc /dev/sdd\033[0m'
#+ echo -e '\033[0;37mCPR: \033[0m'
7Devices:/dev/sda /dev/sdb /dev/sdc /dev/sdd
CPR: 
+ jq . /tmp/config.cpr
{
  "disks": [
    {
      "device": "/dev/sdd",
      "wipeTable": true,
      "partitions": [

        {
          "label": "BIOS",
          "number": 1,
          "size": "512M"

         },

        {
          "label": "SWAP",
          "number": 2,
          "size": "3993600"

         },

        {
          "label": "ROOT",
          "number": 3,
          "size": 0

        }
      ]
    }
  ],
  "filesystems": [
    {
      "mount": {
        "device": "/dev/sdd1",
        "format": "vfat",
        "point": "/boot/efi",
        "create": {
          "options": [
            "32",
            "-n",
            "EFI"

           ]

        }
      }
    },
    {
      "mount": {
        "device": "/dev/sdd3",
        "format": "ext4",
        "point": "/",
        "create": {
          "options": [
            "-L",
            "ROOT"

           ]

        }
      }
    },
    {
      "mount": {
        "device": "/dev/sdd2",
        "format": "swap",
        "point": "none",
        "create": {
          "options": [
            "-L",
            "SWAP"

           ]

        }
      }
    }
  ]
}
@+ assert_block_or_loop_devs /dev/sda /dev/sdb /dev/sdc /dev/sdd
+ local baddevs
;++ lsblk -dnro MAJ:MIN /dev/sda /dev/sdb /dev/sdc /dev/sdd
++ filter_bad_devs
:++ grep -vE '^(7|8|6[5-9]|7[01]|12[89]|13[0-5]|25[139]):'

 + baddevs=
<+ assert_same_type_devs /dev/sda /dev/sdb /dev/sdc /dev/sdd
J+ majors=($(lsblk -dnro 'MAJ:MIN' "$@" | awk -F: '{print $1}' | sort -u))
;++ lsblk -dnro MAJ:MIN /dev/sda /dev/sdb /dev/sdc /dev/sdd
++ awk -F: '{print $1}'

 ++ sort -u
+ local majors
+ [[ 8 =~ 7 ]]

+ is_uefi
+ [[ -d /sys/firmware/efi ]]

 + uefi=true
+ [[ false == false ]]
+ [[ false == false ]]
G+ echo -e '\033[0;32mChecking disks for existing partitions...\033[0m'
5Checking disks for existing partitions...
/+ fdisk -l /dev/sda /dev/sdb /dev/sdc /dev/sdd
+ grep Disklabel
5+ echo 'Disk candidates are ready for partitioning.'
:+ echo -e '\033[0;32m#### Running CPR disk config\033[0m'
,Disk candidates are ready for partitioning.
(#### Running CPR disk config

 + UEFI=true
3+ ./cpr.sh /tmp/config.cpr /mnt/target false false
+ tee /statedir/cpr.json
+ set -o nounset
+ fstab=/tmp/fstab.tmpl
+ config=/tmp/config.cpr
+ target=/mnt/target
+ preserve_data=false
+ deprovision_fast=false
J+ check_required_arg /tmp/config.cpr 'cpr config' 'config as first param'
+ arg=/tmp/config.cpr
+ name='cpr config'
!+ switch='config as first param'
+ [[ -n /tmp/config.cpr ]]

 + return 0
M+ check_required_arg /mnt/target 'target directory' 'target as second param'
+ arg=/mnt/target
+ name='target directory'
"+ switch='target as second param'
+ [[ -n /mnt/target ]]

 + return 0
]+ check_required_arg false 'should data volumes be preserved' 'preserve_data as third param'

 + arg=false
*+ name='should data volumes be preserved'
(+ switch='preserve_data as third param'
+ [[ -n false ]]

 + return 0
^+ check_required_arg false 'should disk wiping be skipped' 'deprovision_fast as fourth param'

 + arg=false
'+ name='should disk wiping be skipped'
,+ switch='deprovision_fast as fourth param'
+ [[ -n false ]]

 + return 0
+ case $# in
+ setup_disks
'+ disks=($(stormeta 'disks[].device'))
++ stormeta 'disks[].device'
+++ jq -r '.disks[].device' /tmp/config.cpr
++ msg '########## setting raids #########'
9+ echo -e '########## setting raids #########' '\033[0m'
(########## setting raids ######### 
+ raids=('hack')
4+ fsdevs=($(stormeta 'filesystems[].mount.device'))
)++ stormeta 'filesystems[].mount.device'
7++ jq -r '.filesystems[].mount.device' /tmp/config.cpr
+ stormeta 'raid[0].devices[]'
A+ msg 'No raid defined in config json - skipping raid config...'
O+ echo -e 'No raid defined in config json - skipping raid config...' '\033[0m'
>No raid defined in config json - skipping raid config... 
+ msg 'Disks: /dev/sdd'
&+ echo -e 'Disks: /dev/sdd' '\033[0m'
Disks: /dev/sdd 

 + diskcnt=0
+ for disk in '"${disks[@]}"'
)+ msg 'Writing disk config for /dev/sdd'
7+ echo -e 'Writing disk config for /dev/sdd' '\033[0m'
&Writing disk config for /dev/sdd 
+ [[ false == true ]]
+ [[ false == true ]]
<+ parts=($(stormeta "disks[$diskcnt].partitions[].number"))
+++ stormeta 'disks[0].partitions[].number'
9++ jq -r '.disks[0].partitions[].number' /tmp/config.cpr

 ++ seq 0 2
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[0].label'
9++ jq -r '.disks[0].partitions[0].label' /tmp/config.cpr
+ partlabel=BIOS
,++ stormeta 'disks[0].partitions[0].number'
:++ jq -r '.disks[0].partitions[0].number' /tmp/config.cpr

 + partnum=1
*++ stormeta 'disks[0].partitions[0].size'
8++ jq -r '.disks[0].partitions[0].size' /tmp/config.cpr
+ partsize=512M
+ parttype=8300
A+ msg 'Working on /dev/sdd part 1 aka label BIOS with size 512M'
O+ echo -e 'Working on /dev/sdd part 1 aka label BIOS with size 512M' '\033[0m'
>Working on /dev/sdd part 1 aka label BIOS with size 512M 
+ [[ BIOS =~ BIOS ]]
+ bootdevs+=("$disk")
+ case ${UEFI:-} in
+ humantype='EFI system'
+ parttype=ef00
B+ msg 'label contains BIOS, setting partition type as EFI system'
P+ echo -e 'label contains BIOS, setting partition type as EFI system' '\033[0m'
?label contains BIOS, setting partition type as EFI system 
+ [[ 512M =~ pct ]]
+ (( partsize == 0 ))
O./cpr.sh: line 105: ((: 512M: value too great for base (error token is "512M")
+ partsize=+512M
3+ sgdisk -n 1:0:+512M -c 1:BIOS -t 1:ef00 /dev/sdd
Creating new GPT entries.
Setting name!
partNum is 0
REALLY setting name!
*The operation has completed successfully.
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[1].label'
9++ jq -r '.disks[0].partitions[1].label' /tmp/config.cpr
+ partlabel=SWAP
,++ stormeta 'disks[0].partitions[1].number'
:++ jq -r '.disks[0].partitions[1].number' /tmp/config.cpr

 + partnum=2
*++ stormeta 'disks[0].partitions[1].size'
8++ jq -r '.disks[0].partitions[1].size' /tmp/config.cpr
+ partsize=3993600
+ parttype=8300
D+ msg 'Working on /dev/sdd part 2 aka label SWAP with size 3993600'
R+ echo -e 'Working on /dev/sdd part 2 aka label SWAP with size 3993600' '\033[0m'
AWorking on /dev/sdd part 2 aka label SWAP with size 3993600 
+ [[ SWAP =~ BIOS ]]
+ [[ 3993600 =~ pct ]]
+ (( partsize == 0 ))
+ partsize=+3993600
6+ sgdisk -n 2:0:+3993600 -c 2:SWAP -t 2:8300 /dev/sdd
Setting name!
partNum is 1
REALLY setting name!
*The operation has completed successfully.
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[2].label'
9++ jq -r '.disks[0].partitions[2].label' /tmp/config.cpr
+ partlabel=ROOT
,++ stormeta 'disks[0].partitions[2].number'
:++ jq -r '.disks[0].partitions[2].number' /tmp/config.cpr

 + partnum=3
*++ stormeta 'disks[0].partitions[2].size'
8++ jq -r '.disks[0].partitions[2].size' /tmp/config.cpr
+ partsize=0
+ parttype=8300
>+ msg 'Working on /dev/sdd part 3 aka label ROOT with size 0'
L+ echo -e 'Working on /dev/sdd part 3 aka label ROOT with size 0' '\033[0m'
;Working on /dev/sdd part 3 aka label ROOT with size 0 
+ [[ ROOT =~ BIOS ]]
+ [[ 0 =~ pct ]]
+ (( partsize == 0 ))
?+ msg 'Partsize is zero. This means use the rest of the disk.'
M+ echo -e 'Partsize is zero. This means use the rest of the disk.' '\033[0m'
<Partsize is zero. This means use the rest of the disk. 
/+ sgdisk -n 3:0:0 -c 3:ROOT -t 3:8300 /dev/sdd
Setting name!
partNum is 2
REALLY setting name!
*The operation has completed successfully.

 + diskcnt=1

 + raidcnt=0
+ for raid in '"${raids[@]}"'
+ [[ hack == \h\a\c\k ]]
+ break

+ fscnt=0
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd1'
7+ echo -e 'Writing filesystem for /dev/sdd1' '\033[0m'
&Writing filesystem for /dev/sdd1 
*++ stormeta 'filesystems[0].mount.format'
8++ jq -r '.filesystems[0].mount.format' /tmp/config.cpr
+ format=vfat
)++ stormeta 'filesystems[0].mount.point'
7++ jq -r '.filesystems[0].mount.point' /tmp/config.cpr
+ mpoint=/boot/efi
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[0].mount.create.options[]'
B++ jq -r '.filesystems[0].mount.create.options[]' /tmp/config.cpr

+ fscnt=1
E+ msg '/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi"'
S+ echo -e '/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi"' '\033[0m'
B/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi" 
+ [[ vfat == \b\i\o\s ]]
+ [[ vfat == \s\w\a\p ]]
#+ mkfs.vfat -F 32 -n EFI /dev/sdd1
mkfs.fat 3.0.28 (2015-05-16)
$++ blkid -s UUID -o value /dev/sdd1
+ thisdevuuid=192C-BA9E
+ [[ /boot/efi == / ]]
(+ add_to_fstab 192C-BA9E /boot/efi vfat
[+ local UUID=192C-BA9E MOUNTPOINT=/boot/efi FSFORMAT=vfat options=errors=remount-ro fsck=2
%+ grep -qs 192C-BA9E /tmp/fstab.tmpl
+ [[ vfat == swap ]]
+ [[ /boot/efi == \/ ]]
E+ echo -e 'UUID=192C-BA9E\t/boot/efi\tvfat\terrors=remount-ro\t0\t2'
+ tee -a /tmp/fstab.tmpl
4UUID=192C-BA9E	/boot/efi	vfat	errors=remount-ro	0	2
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd3'
7+ echo -e 'Writing filesystem for /dev/sdd3' '\033[0m'
&Writing filesystem for /dev/sdd3 
*++ stormeta 'filesystems[1].mount.format'
8++ jq -r '.filesystems[1].mount.format' /tmp/config.cpr
+ format=ext4
)++ stormeta 'filesystems[1].mount.point'
7++ jq -r '.filesystems[1].mount.point' /tmp/config.cpr

 + mpoint=/
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[1].mount.create.options[]'
B++ jq -r '.filesystems[1].mount.create.options[]' /tmp/config.cpr

+ fscnt=2
;+ msg '/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/"'
I+ echo -e '/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/"' '\033[0m'
8/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/" 
+ [[ ext4 == \b\i\o\s ]]
+ [[ ext4 == \s\w\a\p ]]
!+ mkfs.ext4 -F -L ROOT /dev/sdd3
mke2fs 1.42.13 (17-May-2015)
[Discarding device blocks: done                            
?Creating filesystem with 28674673 4k blocks and 7176192 inodes
6Filesystem UUID: 0d83961f-5b01-4775-888c-8095432d9e46
&Superblock backups stored on blocks: 
J	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
0	4096000, 7962624, 11239424, 20480000, 23887872

VAllocating group tables: done                            
SWriting inode tables: done                            
&Creating journal (32768 blocks): done
\Writing superblocks and filesystem accounting information: done   

$++ blkid -s UUID -o value /dev/sdd3
3+ thisdevuuid=0d83961f-5b01-4775-888c-8095432d9e46
+ [[ / == / ]]
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
;+ add_to_fstab 0d83961f-5b01-4775-888c-8095432d9e46 / ext4
n+ local UUID=0d83961f-5b01-4775-888c-8095432d9e46 MOUNTPOINT=/ FSFORMAT=ext4 options=errors=remount-ro fsck=2
@+ grep -qs 0d83961f-5b01-4775-888c-8095432d9e46 /tmp/fstab.tmpl
+ [[ ext4 == swap ]]
+ [[ / == \/ ]]
	+ fsck=1
X+ echo -e 'UUID=0d83961f-5b01-4775-888c-8095432d9e46\t/\text4\terrors=remount-ro\t0\t1'
+ tee -a /tmp/fstab.tmpl
GUUID=0d83961f-5b01-4775-888c-8095432d9e46	/	ext4	errors=remount-ro	0	1
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd2'
7+ echo -e 'Writing filesystem for /dev/sdd2' '\033[0m'
&Writing filesystem for /dev/sdd2 
*++ stormeta 'filesystems[2].mount.format'
8++ jq -r '.filesystems[2].mount.format' /tmp/config.cpr
+ format=swap
)++ stormeta 'filesystems[2].mount.point'
7++ jq -r '.filesystems[2].mount.point' /tmp/config.cpr
+ mpoint=none
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[2].mount.create.options[]'
B++ jq -r '.filesystems[2].mount.create.options[]' /tmp/config.cpr

+ fscnt=3
>+ msg '/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none"'
L+ echo -e '/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none"' '\033[0m'
;/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none" 
+ [[ swap == \b\i\o\s ]]
+ [[ swap == \s\w\a\p ]]
+ mkswap /dev/sdd2
7mkswap: /dev/sdd2: warning: wiping old swap signature.
BSetting up swapspace version 1, size = 1.9 GiB (2044719104 bytes)
4no label, UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b
$++ blkid -s UUID -o value /dev/sdd2
3+ thisdevuuid=63caa65d-cf33-45d9-81e5-58f9e36f789b
+ [[ none == / ]]
>+ add_to_fstab 63caa65d-cf33-45d9-81e5-58f9e36f789b none swap
q+ local UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b MOUNTPOINT=none FSFORMAT=swap options=errors=remount-ro fsck=2
@+ grep -qs 63caa65d-cf33-45d9-81e5-58f9e36f789b /tmp/fstab.tmpl
+ [[ swap == swap ]]
	+ fsck=0
+ options=none
+ [[ none == \/ ]]
N+ echo -e 'UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b\tnone\tswap\tnone\t0\t0'
+ tee -a /tmp/fstab.tmpl
=UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b	none	swap	none	0	0
+ cat

+ python3
&{"bootdevs": ["/dev/sdd"], "fstab": "UUID=192C-BA9E\t/boot/efi\tvfat\terrors=remount-ro\t0\t2\nUUID=0d83961f-5b01-4775-888c-8095432d9e46\t/\text4\terrors=remount-ro\t0\t1\nUUID=63caa65d-cf33-45d9-81e5-58f9e36f789b\tnone\tswap\tnone\t0\t0\n", "rootuuid": "0d83961f-5b01-4775-888c-8095432d9e46"}
D+ msg '\033[0;32m#### Mounting filesystems in fstab to /mnt/target'
R+ echo -e '\033[0;32m#### Mounting filesystems in fstab to /mnt/target' '\033[0m'
>#### Mounting filesystems in fstab to /mnt/target 
9+ sed -i 's|\(\S\)\t/|\1\t/mnt/target/|' /tmp/fstab.tmpl
+ read -r mnt
.++ awk '/\/mnt\// {print $2}' /tmp/fstab.tmpl
++ sort
+ mkdir -p /mnt/target/
-+ mount --fstab /tmp/fstab.tmpl /mnt/target/
+ read -r mnt
 + mkdir -p /mnt/target/boot/efi
5+ mount --fstab /tmp/fstab.tmpl /mnt/target/boot/efi
+ read -r mnt
+ mount
+ grep /mnt/target
7tmpfs on /mnt/target type tmpfs (rw,relatime,mode=755)
@tmpfs on /mnt/target/boot/efi type tmpfs (rw,relatime,mode=755)
P/dev/sdd3 on /mnt/target type ext4 (rw,relatime,errors=remount-ro,data=ordered)
�/dev/sdd1 on /mnt/target/boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=utf8,shortname=mixed,errors=remount-ro)
a+ echo -e '\033[0;32m#### Retrieving image archive and installing to target /mnt/target \033[0m'
O#### Retrieving image archive and installing to target /mnt/target 
�+ tar --xattrs --acls --selinux --numeric-owner --same-owner --warning=no-timestamp -zxpf /tmp/assets/image.tar.gz -C /mnt/target
"+ jq -r .fstab /statedir/cpr.json
<+ mkdir -p /mnt/target/dev /mnt/target/proc /mnt/target/sys
!+ mkdir -p /mnt/target/etc/mdadm
2+ [[ c2.medium.x86 != \t\1\.\s\m\a\l\l\.\x\8\6 ]]
@+ echo -e '\033[0;32m#### Updating MD RAID config file \033[0m'
+ mdadm --examine --scan
.#### Updating MD RAID config file 
5+ echo -e '\033[0;32m#### Setting machine-id\033[0m'
G+ rm -f /mnt/target/etc/machine-id /mnt/target/var/lib/dbus/machine-id
##### Setting machine-id
.+ systemd-machine-id-setup --root=/mnt/target
/Initializing machine ID from random generator.
!+ cat /mnt/target/etc/machine-id
!64d2b4236a4f4c2cbdcdc1d5d689e28d
$+ [[ -d /mnt/target/var/lib/dbus ]]
>+ ln -nsf /etc/machine-id /mnt/target/var/lib/dbus/machine-id
]+ echo -e '\033[0;32m#### Copying kernel, modules, and initrd to target /mnt/target \033[0m'
K#### Copying kernel, modules, and initrd to target /mnt/target 
P+ tar --warning=no-timestamp -zxf /tmp/assets/kernel.tar.gz -C /mnt/target/boot
,++ vmlinuz_version /mnt/target/boot/vmlinuz
)++ local kernel=/mnt/target/boot/vmlinuz
++ set +o pipefail
%+++ file -b /mnt/target/boot/vmlinuz
�++ type='Linux kernel x86 boot executable bzImage, version 4.15.0-50-generic (buildd@lcy01-amd64-013) #54-Ubuntu SMP Mon M, RO-rootFS, swap_dev 0x7, Normal VGA'
++ case "$type" in
!++ echo 'kernel is type bzImage'
kernel is type bzImage
�++ echo 'Linux kernel x86 boot executable bzImage, version 4.15.0-50-generic (buildd@lcy01-amd64-013) #54-Ubuntu SMP Mon M, RO-rootFS, swap_dev 0x7, Normal VGA'
'++ sed 's|.*, version \(\S\+\) .*|\1|'
++ set -o pipefail
+ kversion=4.15.0-50-generic
+ [[ -z 4.15.0-50-generic ]]
'+ kernelname=vmlinuz-4.15.0-50-generic
 + [[ ubuntu_18_04 =~ ^centos ]]
+ [[ ubuntu_18_04 =~ ^rhel ]]
*+ initrdname=initrd.img-4.15.0-50-generic
+ modulesdest=
I+ mv /mnt/target/boot/vmlinuz /mnt/target/boot/vmlinuz-4.15.0-50-generic
=+ ln -nsf vmlinuz-4.15.0-50-generic /mnt/target/boot/vmlinuz
<+ tar --warning=no-timestamp -zxf /tmp/assets/initrd.tar.gz
:+ mv initrd /mnt/target/boot/initrd.img-4.15.0-50-generic
?+ ln -nsf initrd.img-4.15.0-50-generic /mnt/target/boot/initrd
M+ tar --warning=no-timestamp -zxf /tmp/assets/modules.tar.gz -C /mnt/target/
A+ cp /mnt/target/boot/vmlinuz-4.15.0-50-generic /statedir/kernel
D+ cp /mnt/target/boot/initrd.img-4.15.0-50-generic /statedir/initrd
3+ echo -e '\033[0;32m#### Installing GRUB2\033[0m'
p+ wget http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template -O /tmp/grub.template
!#### Installing GRUB2
l--2020-02-11 04:46:36--  http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template
+Connecting to 192.168.1.2:80... connected.
/HTTP request sent, awaiting response... 200 OK
/Length: 2202 (2.2K) [application/octet-stream]
 Saving to: '/tmp/grub.template'

L     0K ..                                                    100% 37.0M=0s

I2020-02-11 04:46:36 (37.0 MB/s) - '/tmp/grub.template' saved [2202/2202]

w+ wget http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template.default -O /tmp/grub.default
t--2020-02-11 04:46:36--  http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template.default
+Connecting to 192.168.1.2:80... connected.
/HTTP request sent, awaiting response... 200 OK
'Length: 168 [application/octet-stream]
Saving to: '/tmp/grub.default'

L     0K                                                       100% 50.6M=0s

F2020-02-11 04:46:36 (50.6 MB/s) - '/tmp/grub.default' saved [168/168]

7+ mount -t efivarfs efivarfs /sys/firmware/efi/efivars
+ mount
8overlay on / type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/KMKKN2TTVKYT5PX3QA6QP3XZ4M:/var/lib/docker/overlay2/l/3S2PKK6NOM7P4LOPBMZFG6OXIT:/var/lib/docker/overlay2/l/Z7N5WJEUPG3OVGVX56Z63EG2HK:/var/lib/docker/overlay2/l/H3M44XER4QBHKQ7MEHMFVRY7DI:/var/lib/docker/overlay2/l/XF7HTATY6YRE5OOF54XN2IFLYS:/var/lib/docker/overlay2/l/BQMA6NCC26ADZZDRUZUBZZNT5Z:/var/lib/docker/overlay2/l/KORFEDBTJENL4TNAUMYREYFMGB:/var/lib/docker/overlay2/l/P4ZPV6PO5FHALMEOIZXL3AIJZW:/var/lib/docker/overlay2/l/YIS3FL7WONPD3JGP66SMTKB2XD:/var/lib/docker/overlay2/l/AVHX4WGTWODU4NEYJJSA5DRGQL:/var/lib/docker/overlay2/l/KGPN6SGQZ4M3BJCRY7RKSMTRZO:/var/lib/docker/overlay2/l/BBYKXHCY7TD4XDNTRZJPTBT6TK:/var/lib/docker/overlay2/l/2ARNEQ7QLNPA25EGOZH7O5H7BO:/var/lib/docker/overlay2/l/WZDUGLWPKO47DQUCXVZZFRVSEW:/var/lib/docker/overlay2/l/LVEBUE66F3BCHY7WWH7VJUQ6YH:/var/lib/docker/overlay2/l/6VYQU42IYZPDBEN7IQURX4WYDI:/var/lib/docker/overlay2/l/6UYOO2UW47DURTYFZ7KXYKEQQX:/var/lib/docker/overlay2/l/LROHBLGGR636TSAPN5GQMNFIKE:/var/lib/docker/overlay2/l/3JUDEU5QN6S4SPI2LPANNTUC5L:/var/lib/docker/overlay2/l/U2PMHQGRASO7BNMGTJLHACHWM4,upperdir=/var/lib/docker/overlay2/fcc6fc7ad84d0ea091ae33da5a7a34483e2d4047f244d73eba7fb3f1037ec4e3/diff,workdir=/var/lib/docker/overlay2/fcc6fc7ad84d0ea091ae33da5a7a34483e2d4047f244d73eba7fb3f1037ec4e3/work)
:proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
;sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
Ntmpfs on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,mode=755)
�openrc on /sys/fs/cgroup/openrc type cgroup (rw,nosuid,nodev,noexec,relatime,release_agent=/lib/rc/sh/cgroup-release-agent.sh,name=openrc)
Ucpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
Lcpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)
Xcpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)
Rblkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
Umemory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
Xdevices on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
Xfreezer on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
Xnet_cls on /sys/fs/cgroup/net_cls type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls)
[net_prio on /sys/fs/cgroup/net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio)
Opids on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
3tmpfs on /worker type tmpfs (rw,relatime,mode=755)
0tmpfs on /mnt type tmpfs (rw,relatime,mode=755)
[devtmpfs on /dev type devtmpfs (rw,nosuid,relatime,size=10240k,nr_inodes=8194836,mode=755)
Wdevpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
=shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime)
Dmqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)
5tmpfs on /statedir type tmpfs (rw,relatime,mode=755)
5tmpfs on /workflow type tmpfs (rw,relatime,mode=755)
7tmpfs on /mnt/target type tmpfs (rw,relatime,mode=755)
7tmpfs on /tmp/assets type tmpfs (rw,relatime,mode=755)
cdevtmpfs on /dev/console type devtmpfs (rw,nosuid,relatime,size=10240k,nr_inodes=8194836,mode=755)
A/lib/modloop-x86_64 on /lib/firmware type squashfs (ro,relatime)
6tmpfs on /etc/hosts type tmpfs (rw,relatime,mode=755)
<tmpfs on /etc/resolv.conf type tmpfs (rw,relatime,mode=755)
9tmpfs on /etc/hostname type tmpfs (rw,relatime,mode=755)
Ishm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=65536k)
@tmpfs on /mnt/target/boot/efi type tmpfs (rw,relatime,mode=755)
P/dev/sdd3 on /mnt/target type ext4 (rw,relatime,errors=remount-ro,data=ordered)
�/dev/sdd1 on /mnt/target/boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=utf8,shortname=mixed,errors=remount-ro)
Befivarfs on /sys/firmware/efi/efivars type efivarfs (rw,relatime)
z+ ./grub-installer.sh -v -p c2.medium.x86 -t /mnt/target -C /statedir/cpr.json -D /tmp/grub.default -T /tmp/grub.template
K+ USAGE='Usage: ./grub-installer.sh -t /mnt/target -C /path/to/cprout.json
Required Arguments:
-	-p plan      Server plan (ex: t1.small.x86)
5	-t target    Target mount point to write configs to
9	-C path      Path to file containing cpr.sh output json
,	-D path      Path to grub.default template
(	-T path      Path to grub.cfg template

	Options:
 	-h           This help message
5	-v           Turn on verbose messages for debugging

CDescription: This script will configure grub for the target distro
'
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
	+ set -x
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ plan=c2.medium.x86
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ target=/mnt/target
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ cprout=/statedir/cpr.json
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
!+ default_path=/tmp/grub.default
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
#+ template_path=/tmp/grub.template
+ getopts p:t:C:D:T:hv OPTION
�+ assert_all_args_consumed 12 -v -p c2.medium.x86 -t /mnt/target -C /statedir/cpr.json -D /tmp/grub.default -T /tmp/grub.template
+ local index=12
+ shift
+ (( index != 11 + 1 ))
$+ grep -qs /mnt/target /proc/mounts
$+ echo 'Target is mounted... good.'
Target is mounted... good.
+ rm -rf /mnt/target/boot/grub
"+ [[ -d /mnt/target/boot/grub2 ]]
"+ mkdir -p /mnt/target/boot/grub2
'+ ln -nsfT grub2 /mnt/target/boot/grub
&++ jq -r .rootuuid /statedir/cpr.json
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
0+ [[ -n 0d83961f-5b01-4775-888c-8095432d9e46 ]]
S+ sed s/PACKET_ROOT_UUID/0d83961f-5b01-4775-888c-8095432d9e46/g /tmp/grub.template
F++ sed -nr 's|GRUB_CMDLINE_LINUX='\''(.*)'\''|\1|p' /tmp/grub.default
L+ cmdline='console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
aDetected cmdline: console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1
s+ echo -e '\033[0;33;5;7mDetected cmdline: console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1\033[0m'
*+ sed -i 's|^|export |' /tmp/grub.default
+ source /tmp/grub.default
_++ export 'GRUB_CMDLINE_LINUX=console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
X++ GRUB_CMDLINE_LINUX='console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
]++ export 'GRUB_SERIAL_COMMAND=serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1'
V++ GRUB_SERIAL_COMMAND='serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1'
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
++ awk '{print $1}'
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ GRUB_DISTRIBUTOR=Ubuntu

 + envsubst

+ is_uefi
+ [[ -d /sys/firmware/efi ]]

 + uefi=true

 ++ uname -m
+ arch=x86_64
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ os_ver='Ubuntu 18.04'
+ set -- Ubuntu 18.04
+ DOS=Ubuntu
+ DVER=18.04
/#### Detected OS on mounted target /mnt/target
$OS: Ubuntu  ARCH: x86_64 VER: 18.04
8+ echo '#### Detected OS on mounted target /mnt/target'
-+ echo 'OS: Ubuntu  ARCH: x86_64 VER: 18.04'
+ chroot_install=false
?+ [[ Ubuntu == \R\e\d\H\a\t\E\n\t\e\r\p\r\i\s\e\S\e\r\v\e\r ]]
4+ [[ c2.medium.x86 == \c\3\.\m\e\d\i\u\m\.\x\8\6 ]]
*++ jq -r '.bootdevs[]' /statedir/cpr.json
+ bootdevs=/dev/sdd
+ [[ -n /dev/sdd ]]
+ for disk in '$bootdevs'
+ false
+ install_grub_osie
*+ echo 'Running grub-install on /dev/sdd'
+ true
+ [[ x86_64 == aarch64 ]]
!Running grub-install on /dev/sdd
p+ grub-install --recheck --bootloader-id=GRUB --root-directory=/mnt/target --efi-directory=/mnt/target/boot/efi
$Installing for x86_64-efi platform.
*Installation finished. No error reported.
<++ find /mnt/target/boot/efi -name 'grub*.efi' -print -quit
4+ grubefi=/mnt/target/boot/efi/EFI/GRUB/grubx64.efi
5+ [[ -z /mnt/target/boot/efi/EFI/GRUB/grubx64.efi ]]
+ [[ x86_64 == aarch64 ]]
+ efibootmgr
+ tee /dev/stderr
+ grep -iq grub
BootCurrent: 0000
BootOrder: 0004,0000
Boot0000* NIC in Slot 2 Port 1
Boot0001* Hard drive C:
*Boot0002* FlexBoot v3.5.403 (PCI 05:00.0)
*Boot0003* FlexBoot v3.5.403 (PCI 05:00.1)
Boot0004* GRUB
&++ jq -r .rootuuid /statedir/cpr.json
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
0+ [[ -n 0d83961f-5b01-4775-888c-8095432d9e46 ]]
F++ sed -nr 's|GRUB_CMDLINE_LINUX='\''(.*)'\''|\1|p' /tmp/grub.default
S+ cmdline='export console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
+ cat
H+ echo -e '\033[0;32m#### Clearing init overrides to enable TTY\033[0m'
6#### Clearing init overrides to enable TTY
++ rm -rf '/mnt/target/etc/init/*.override'
+ [[ false == false ]]
;+ echo -e '\033[0;32m#### Setting up package repos\033[0m'
)#### Setting up package repos
;+ ./repos.sh -a x86_64 -t /mnt/target -f ewr1 -M /metadata
*+ USAGE='Usage: ./repos.sh -t /mnt/target
Required Arguments:
2	-a arch     System architecture {aarch64|x86_64}
/	-M metadata File containing instance metadata
2	-t target   Target mount point to write repos to

	Options:
7	-f facility Facility to use to reach artifacts server
z	-m url      Address to embed into OS for package repository (advanced usage, default http://mirror.$facility.packet.net)
	-h          This help message
4	-v          Turn on verbose messages for debugging

|Description: This script will configure the package repositories based upon LSB properties located on a target mount point.
'
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ arch=x86_64
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ export TARGET=/mnt/target
+ TARGET=/mnt/target
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ facility=ewr1
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ metadata=/metadata
+ getopts a:M:t:f:m:hv OPTION
$+ check_required_arg x86_64 arch -a
+ arg=x86_64

 + name=arch

 + switch=-a
+ [[ -n x86_64 ]]

 + return 0
2+ check_required_arg /metadata 'metadata file' -M
+ arg=/metadata
+ name='metadata file'

 + switch=-M
+ [[ -n /metadata ]]

 + return 0
9+ check_required_arg /mnt/target 'target mount point' -t
+ arg=/mnt/target
+ name='target mount point'

 + switch=-t
+ [[ -n /mnt/target ]]

 + return 0
K+ assert_all_args_consumed 9 -a x86_64 -t /mnt/target -f ewr1 -M /metadata
+ local index=9
+ shift
+ (( index != 8 + 1 ))
'+ mirror=http://mirror.ewr1.packet.net
$+ grep -qs /mnt/target /proc/mounts
$+ echo 'Target is mounted... good.'
Target is mounted... good.
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ os_ver='Ubuntu 18.04'
+ set -- Ubuntu 18.04
+ DOS=Ubuntu
+ DVER=18.04
8+ echo '#### Detected OS on mounted target /mnt/target'
-+ echo 'OS: Ubuntu  ARCH: x86_64 VER: 18.04'
/#### Detected OS on mounted target /mnt/target
$OS: Ubuntu  ARCH: x86_64 VER: 18.04
+ case "$DOS" in

 + do_ubuntu
+ case "$DVER" in
+ do_ubuntu_18_04_x86_64
,+ echo 'Configuring repos for Ubuntu 18.04'
#Configuring repos for Ubuntu 18.04
+ cat
	+ exit 0
D+ echo -e '\033[0;32m#### Configuring cloud-init for Packet\033[0m'
-+ '[' -f /mnt/target/etc/cloud/cloud.cfg ']'
2#### Configuring cloud-init for Packet
+ case ${OS} in
+ repo_module=apt-configure
+ cat
K+ echo 'Disabling cloud-init based network config via cloud.cfg.d include'
%+ echo 'network: {config: disabled}'
BDisabling cloud-init based network config via cloud.cfg.d include
#WARNING: Removing /var/lib/cloud/*
,+ echo 'WARNING: Removing /var/lib/cloud/*'
'+ rm -rf '/mnt/target/var/lib/cloud/*'
;+ '[' -f /mnt/target/etc/cloud/cloud.cfg.d/90_dpkg.cfg ']'
+ cat
8+ '[' -f /mnt/target/etc/init/cloud-init-nonet.conf ']'
ICloud-init post-install - cloud-init-nonet does not exist. skipping edit
R+ echo 'Cloud-init post-install - cloud-init-nonet does not exist. skipping edit'
.+ [[ -f /mnt/target/etc/init/failsafe.conf ]]
+ mkdir /home/packet
_+ wget http://192.168.1.2/misc/osie/current/github/packet-block-storage-attach -P /home/packet
a--2020-02-11 04:46:39--  http://192.168.1.2/misc/osie/current/github/packet-block-storage-attach
+Connecting to 192.168.1.2:80... connected.
6HTTP request sent, awaiting response... 404 Not Found
*2020-02-11 04:46:39 ERROR 404: Not Found.

{"level":"info","msg":"Container with id  4c1bdbb318001ddbd848b50f761f95786e40e7f0e3f0bd6b951f4b54b7c18b45 finished with status code :  8","time":"2020-02-11T04:46:47Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
Creating new GPT entries.
Setting name!
partNum is 0
REALLY setting name!
*The operation has completed successfully.
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[1].label'
9++ jq -r '.disks[0].partitions[1].label' /tmp/config.cpr
+ partlabel=SWAP
,++ stormeta 'disks[0].partitions[1].number'
:++ jq -r '.disks[0].partitions[1].number' /tmp/config.cpr

 + partnum=2
*++ stormeta 'disks[0].partitions[1].size'
8++ jq -r '.disks[0].partitions[1].size' /tmp/config.cpr
+ partsize=3993600
+ parttype=8300
D+ msg 'Working on /dev/sdd part 2 aka label SWAP with size 3993600'
R+ echo -e 'Working on /dev/sdd part 2 aka label SWAP with size 3993600' '\033[0m'
AWorking on /dev/sdd part 2 aka label SWAP with size 3993600 
+ [[ SWAP =~ BIOS ]]
+ [[ 3993600 =~ pct ]]
+ (( partsize == 0 ))
+ partsize=+3993600
6+ sgdisk -n 2:0:+3993600 -c 2:SWAP -t 2:8300 /dev/sdd
Setting name!
partNum is 1
REALLY setting name!
*The operation has completed successfully.
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[2].label'
9++ jq -r '.disks[0].partitions[2].label' /tmp/config.cpr
+ partlabel=ROOT
,++ stormeta 'disks[0].partitions[2].number'
:++ jq -r '.disks[0].partitions[2].number' /tmp/config.cpr

 + partnum=3
*++ stormeta 'disks[0].partitions[2].size'
8++ jq -r '.disks[0].partitions[2].size' /tmp/config.cpr
+ partsize=0
+ parttype=8300
>+ msg 'Working on /dev/sdd part 3 aka label ROOT with size 0'
L+ echo -e 'Working on /dev/sdd part 3 aka label ROOT with size 0' '\033[0m'
;Working on /dev/sdd part 3 aka label ROOT with size 0 
+ [[ ROOT =~ BIOS ]]
+ [[ 0 =~ pct ]]
+ (( partsize == 0 ))
?+ msg 'Partsize is zero. This means use the rest of the disk.'
M+ echo -e 'Partsize is zero. This means use the rest of the disk.' '\033[0m'
<Partsize is zero. This means use the rest of the disk. 
/+ sgdisk -n 3:0:0 -c 3:ROOT -t 3:8300 /dev/sdd
Setting name!
partNum is 2
REALLY setting name!
*The operation has completed successfully.

 + diskcnt=1

 + raidcnt=0
+ for raid in '"${raids[@]}"'
+ [[ hack == \h\a\c\k ]]
+ break

+ fscnt=0
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd1'
7+ echo -e 'Writing filesystem for /dev/sdd1' '\033[0m'
&Writing filesystem for /dev/sdd1 
*++ stormeta 'filesystems[0].mount.format'
8++ jq -r '.filesystems[0].mount.format' /tmp/config.cpr
+ format=vfat
)++ stormeta 'filesystems[0].mount.point'
7++ jq -r '.filesystems[0].mount.point' /tmp/config.cpr
+ mpoint=/boot/efi
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[0].mount.create.options[]'
B++ jq -r '.filesystems[0].mount.create.options[]' /tmp/config.cpr

+ fscnt=1
E+ msg '/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi"'
S+ echo -e '/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi"' '\033[0m'
B/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi" 
+ [[ vfat == \b\i\o\s ]]
+ [[ vfat == \s\w\a\p ]]
#+ mkfs.vfat -F 32 -n EFI /dev/sdd1
mkfs.fat 3.0.28 (2015-05-16)
$++ blkid -s UUID -o value /dev/sdd1
+ thisdevuuid=192C-BA9E
+ [[ /boot/efi == / ]]
(+ add_to_fstab 192C-BA9E /boot/efi vfat
[+ local UUID=192C-BA9E MOUNTPOINT=/boot/efi FSFORMAT=vfat options=errors=remount-ro fsck=2
%+ grep -qs 192C-BA9E /tmp/fstab.tmpl
+ [[ vfat == swap ]]
+ [[ /boot/efi == \/ ]]
E+ echo -e 'UUID=192C-BA9E\t/boot/efi\tvfat\terrors=remount-ro\t0\t2'
+ tee -a /tmp/fstab.tmpl
4UUID=192C-BA9E	/boot/efi	vfat	errors=remount-ro	0	2
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd3'
7+ echo -e 'Writing filesystem for /dev/sdd3' '\033[0m'
&Writing filesystem for /dev/sdd3 
*++ stormeta 'filesystems[1].mount.format'
8++ jq -r '.filesystems[1].mount.format' /tmp/config.cpr
+ format=ext4
)++ stormeta 'filesystems[1].mount.point'
7++ jq -r '.filesystems[1].mount.point' /tmp/config.cpr

 + mpoint=/
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[1].mount.create.options[]'
B++ jq -r '.filesystems[1].mount.create.options[]' /tmp/config.cpr

+ fscnt=2
;+ msg '/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/"'
I+ echo -e '/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/"' '\033[0m'
8/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/" 
+ [[ ext4 == \b\i\o\s ]]
+ [[ ext4 == \s\w\a\p ]]
!+ mkfs.ext4 -F -L ROOT /dev/sdd3
mke2fs 1.42.13 (17-May-2015)
[Discarding device blocks: done                            
?Creating filesystem with 28674673 4k blocks and 7176192 inodes
6Filesystem UUID: 0d83961f-5b01-4775-888c-8095432d9e46
&Superblock backups stored on blocks: 
J	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
0	4096000, 7962624, 11239424, 20480000, 23887872

VAllocating group tables: done                            
SWriting inode tables: done                            
&Creating journal (32768 blocks): done
\Writing superblocks and filesystem accounting information: done   

$++ blkid -s UUID -o value /dev/sdd3
3+ thisdevuuid=0d83961f-5b01-4775-888c-8095432d9e46
+ [[ / == / ]]
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
;+ add_to_fstab 0d83961f-5b01-4775-888c-8095432d9e46 / ext4
n+ local UUID=0d83961f-5b01-4775-888c-8095432d9e46 MOUNTPOINT=/ FSFORMAT=ext4 options=errors=remount-ro fsck=2
@+ grep -qs 0d83961f-5b01-4775-888c-8095432d9e46 /tmp/fstab.tmpl
+ [[ ext4 == swap ]]
+ [[ / == \/ ]]
	+ fsck=1
X+ echo -e 'UUID=0d83961f-5b01-4775-888c-8095432d9e46\t/\text4\terrors=remount-ro\t0\t1'
+ tee -a /tmp/fstab.tmpl
GUUID=0d83961f-5b01-4775-888c-8095432d9e46	/	ext4	errors=remount-ro	0	1
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd2'
7+ echo -e 'Writing filesystem for /dev/sdd2' '\033[0m'
&Writing filesystem for /dev/sdd2 
*++ stormeta 'filesystems[2].mount.format'
8++ jq -r '.filesystems[2].mount.format' /tmp/config.cpr
+ format=swap
)++ stormeta 'filesystems[2].mount.point'
7++ jq -r '.filesystems[2].mount.point' /tmp/config.cpr
+ mpoint=none
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[2].mount.create.options[]'
B++ jq -r '.filesystems[2].mount.create.options[]' /tmp/config.cpr

+ fscnt=3
>+ msg '/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none"'
L+ echo -e '/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none"' '\033[0m'
;/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none" 
+ [[ swap == \b\i\o\s ]]
+ [[ swap == \s\w\a\p ]]
+ mkswap /dev/sdd2
7mkswap: /dev/sdd2: warning: wiping old swap signature.
BSetting up swapspace version 1, size = 1.9 GiB (2044719104 bytes)
4no label, UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b
$++ blkid -s UUID -o value /dev/sdd2
3+ thisdevuuid=63caa65d-cf33-45d9-81e5-58f9e36f789b
+ [[ none == / ]]
>+ add_to_fstab 63caa65d-cf33-45d9-81e5-58f9e36f789b none swap
q+ local UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b MOUNTPOINT=none FSFORMAT=swap options=errors=remount-ro fsck=2
@+ grep -qs 63caa65d-cf33-45d9-81e5-58f9e36f789b /tmp/fstab.tmpl
+ [[ swap == swap ]]
	+ fsck=0
+ options=none
+ [[ none == \/ ]]
N+ echo -e 'UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b\tnone\tswap\tnone\t0\t0'
+ tee -a /tmp/fstab.tmpl
=UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b	none	swap	none	0	0
+ cat

+ python3
&{"bootdevs": ["/dev/sdd"], "fstab": "UUID=192C-BA9E\t/boot/efi\tvfat\terrors=remount-ro\t0\t2\nUUID=0d83961f-5b01-4775-888c-8095432d9e46\t/\text4\terrors=remount-ro\t0\t1\nUUID=63caa65d-cf33-45d9-81e5-58f9e36f789b\tnone\tswap\tnone\t0\t0\n", "rootuuid": "0d83961f-5b01-4775-888c-8095432d9e46"}
D+ msg '\033[0;32m#### Mounting filesystems in fstab to /mnt/target'
R+ echo -e '\033[0;32m#### Mounting filesystems in fstab to /mnt/target' '\033[0m'
>#### Mounting filesystems in fstab to /mnt/target 
9+ sed -i 's|\(\S\)\t/|\1\t/mnt/target/|' /tmp/fstab.tmpl
+ read -r mnt
.++ awk '/\/mnt\// {print $2}' /tmp/fstab.tmpl
++ sort
+ mkdir -p /mnt/target/
-+ mount --fstab /tmp/fstab.tmpl /mnt/target/
+ read -r mnt
 + mkdir -p /mnt/target/boot/efi
5+ mount --fstab /tmp/fstab.tmpl /mnt/target/boot/efi
+ read -r mnt
+ mount
+ grep /mnt/target
7tmpfs on /mnt/target type tmpfs (rw,relatime,mode=755)
@tmpfs on /mnt/target/boot/efi type tmpfs (rw,relatime,mode=755)
P/dev/sdd3 on /mnt/target type ext4 (rw,relatime,errors=remount-ro,data=ordered)
�/dev/sdd1 on /mnt/target/boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=utf8,shortname=mixed,errors=remount-ro)
a+ echo -e '\033[0;32m#### Retrieving image archive and installing to target /mnt/target \033[0m'
O#### Retrieving image archive and installing to target /mnt/target 
�+ tar --xattrs --acls --selinux --numeric-owner --same-owner --warning=no-timestamp -zxpf /tmp/assets/image.tar.gz -C /mnt/target
"+ jq -r .fstab /statedir/cpr.json
<+ mkdir -p /mnt/target/dev /mnt/target/proc /mnt/target/sys
!+ mkdir -p /mnt/target/etc/mdadm
2+ [[ c2.medium.x86 != \t\1\.\s\m\a\l\l\.\x\8\6 ]]
@+ echo -e '\033[0;32m#### Updating MD RAID config file \033[0m'
+ mdadm --examine --scan
.#### Updating MD RAID config file 
5+ echo -e '\033[0;32m#### Setting machine-id\033[0m'
G+ rm -f /mnt/target/etc/machine-id /mnt/target/var/lib/dbus/machine-id
##### Setting machine-id
.+ systemd-machine-id-setup --root=/mnt/target
/Initializing machine ID from random generator.
!+ cat /mnt/target/etc/machine-id
!64d2b4236a4f4c2cbdcdc1d5d689e28d
$+ [[ -d /mnt/target/var/lib/dbus ]]
>+ ln -nsf /etc/machine-id /mnt/target/var/lib/dbus/machine-id
]+ echo -e '\033[0;32m#### Copying kernel, modules, and initrd to target /mnt/target \033[0m'
K#### Copying kernel, modules, and initrd to target /mnt/target 
P+ tar --warning=no-timestamp -zxf /tmp/assets/kernel.tar.gz -C /mnt/target/boot
,++ vmlinuz_version /mnt/target/boot/vmlinuz
)++ local kernel=/mnt/target/boot/vmlinuz
++ set +o pipefail
%+++ file -b /mnt/target/boot/vmlinuz
�++ type='Linux kernel x86 boot executable bzImage, version 4.15.0-50-generic (buildd@lcy01-amd64-013) #54-Ubuntu SMP Mon M, RO-rootFS, swap_dev 0x7, Normal VGA'
++ case "$type" in
!++ echo 'kernel is type bzImage'
kernel is type bzImage
�++ echo 'Linux kernel x86 boot executable bzImage, version 4.15.0-50-generic (buildd@lcy01-amd64-013) #54-Ubuntu SMP Mon M, RO-rootFS, swap_dev 0x7, Normal VGA'
'++ sed 's|.*, version \(\S\+\) .*|\1|'
++ set -o pipefail
+ kversion=4.15.0-50-generic
+ [[ -z 4.15.0-50-generic ]]
'+ kernelname=vmlinuz-4.15.0-50-generic
 + [[ ubuntu_18_04 =~ ^centos ]]
+ [[ ubuntu_18_04 =~ ^rhel ]]
*+ initrdname=initrd.img-4.15.0-50-generic
+ modulesdest=
I+ mv /mnt/target/boot/vmlinuz /mnt/target/boot/vmlinuz-4.15.0-50-generic
=+ ln -nsf vmlinuz-4.15.0-50-generic /mnt/target/boot/vmlinuz
<+ tar --warning=no-timestamp -zxf /tmp/assets/initrd.tar.gz
:+ mv initrd /mnt/target/boot/initrd.img-4.15.0-50-generic
?+ ln -nsf initrd.img-4.15.0-50-generic /mnt/target/boot/initrd
M+ tar --warning=no-timestamp -zxf /tmp/assets/modules.tar.gz -C /mnt/target/
A+ cp /mnt/target/boot/vmlinuz-4.15.0-50-generic /statedir/kernel
D+ cp /mnt/target/boot/initrd.img-4.15.0-50-generic /statedir/initrd
3+ echo -e '\033[0;32m#### Installing GRUB2\033[0m'
p+ wget http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template -O /tmp/grub.template
!#### Installing GRUB2
l--2020-02-11 04:46:36--  http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template
+Connecting to 192.168.1.2:80... connected.
/HTTP request sent, awaiting response... 200 OK
/Length: 2202 (2.2K) [application/octet-stream]
 Saving to: '/tmp/grub.template'

L     0K ..                                                    100% 37.0M=0s

I2020-02-11 04:46:36 (37.0 MB/s) - '/tmp/grub.template' saved [2202/2202]

w+ wget http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template.default -O /tmp/grub.default
t--2020-02-11 04:46:36--  http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template.default
+Connecting to 192.168.1.2:80... connected.
/HTTP request sent, awaiting response... 200 OK
'Length: 168 [application/octet-stream]
Saving to: '/tmp/grub.default'

L     0K                                                       100% 50.6M=0s

F2020-02-11 04:46:36 (50.6 MB/s) - '/tmp/grub.default' saved [168/168]

7+ mount -t efivarfs efivarfs /sys/firmware/efi/efivars
+ mount
8overlay on / type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/KMKKN2TTVKYT5PX3QA6QP3XZ4M:/var/lib/docker/overlay2/l/3S2PKK6NOM7P4LOPBMZFG6OXIT:/var/lib/docker/overlay2/l/Z7N5WJEUPG3OVGVX56Z63EG2HK:/var/lib/docker/overlay2/l/H3M44XER4QBHKQ7MEHMFVRY7DI:/var/lib/docker/overlay2/l/XF7HTATY6YRE5OOF54XN2IFLYS:/var/lib/docker/overlay2/l/BQMA6NCC26ADZZDRUZUBZZNT5Z:/var/lib/docker/overlay2/l/KORFEDBTJENL4TNAUMYREYFMGB:/var/lib/docker/overlay2/l/P4ZPV6PO5FHALMEOIZXL3AIJZW:/var/lib/docker/overlay2/l/YIS3FL7WONPD3JGP66SMTKB2XD:/var/lib/docker/overlay2/l/AVHX4WGTWODU4NEYJJSA5DRGQL:/var/lib/docker/overlay2/l/KGPN6SGQZ4M3BJCRY7RKSMTRZO:/var/lib/docker/overlay2/l/BBYKXHCY7TD4XDNTRZJPTBT6TK:/var/lib/docker/overlay2/l/2ARNEQ7QLNPA25EGOZH7O5H7BO:/var/lib/docker/overlay2/l/WZDUGLWPKO47DQUCXVZZFRVSEW:/var/lib/docker/overlay2/l/LVEBUE66F3BCHY7WWH7VJUQ6YH:/var/lib/docker/overlay2/l/6VYQU42IYZPDBEN7IQURX4WYDI:/var/lib/docker/overlay2/l/6UYOO2UW47DURTYFZ7KXYKEQQX:/var/lib/docker/overlay2/l/LROHBLGGR636TSAPN5GQMNFIKE:/var/lib/docker/overlay2/l/3JUDEU5QN6S4SPI2LPANNTUC5L:/var/lib/docker/overlay2/l/U2PMHQGRASO7BNMGTJLHACHWM4,upperdir=/var/lib/docker/overlay2/fcc6fc7ad84d0ea091ae33da5a7a34483e2d4047f244d73eba7fb3f1037ec4e3/diff,workdir=/var/lib/docker/overlay2/fcc6fc7ad84d0ea091ae33da5a7a34483e2d4047f244d73eba7fb3f1037ec4e3/work)
:proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
;sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
Ntmpfs on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,mode=755)
�openrc on /sys/fs/cgroup/openrc type cgroup (rw,nosuid,nodev,noexec,relatime,release_agent=/lib/rc/sh/cgroup-release-agent.sh,name=openrc)
Ucpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
Lcpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)
Xcpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)
Rblkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
Umemory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
Xdevices on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
Xfreezer on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
Xnet_cls on /sys/fs/cgroup/net_cls type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls)
[net_prio on /sys/fs/cgroup/net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio)
Opids on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
3tmpfs on /worker type tmpfs (rw,relatime,mode=755)
0tmpfs on /mnt type tmpfs (rw,relatime,mode=755)
[devtmpfs on /dev type devtmpfs (rw,nosuid,relatime,size=10240k,nr_inodes=8194836,mode=755)
Wdevpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
=shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime)
Dmqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)
5tmpfs on /statedir type tmpfs (rw,relatime,mode=755)
5tmpfs on /workflow type tmpfs (rw,relatime,mode=755)
7tmpfs on /mnt/target type tmpfs (rw,relatime,mode=755)
7tmpfs on /tmp/assets type tmpfs (rw,relatime,mode=755)
cdevtmpfs on /dev/console type devtmpfs (rw,nosuid,relatime,size=10240k,nr_inodes=8194836,mode=755)
A/lib/modloop-x86_64 on /lib/firmware type squashfs (ro,relatime)
6tmpfs on /etc/hosts type tmpfs (rw,relatime,mode=755)
<tmpfs on /etc/resolv.conf type tmpfs (rw,relatime,mode=755)
9tmpfs on /etc/hostname type tmpfs (rw,relatime,mode=755)
Ishm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=65536k)
@tmpfs on /mnt/target/boot/efi type tmpfs (rw,relatime,mode=755)
P/dev/sdd3 on /mnt/target type ext4 (rw,relatime,errors=remount-ro,data=ordered)
�/dev/sdd1 on /mnt/target/boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=utf8,shortname=mixed,errors=remount-ro)
Befivarfs on /sys/firmware/efi/efivars type efivarfs (rw,relatime)
z+ ./grub-installer.sh -v -p c2.medium.x86 -t /mnt/target -C /statedir/cpr.json -D /tmp/grub.default -T /tmp/grub.template
K+ USAGE='Usage: ./grub-installer.sh -t /mnt/target -C /path/to/cprout.json
Required Arguments:
-	-p plan      Server plan (ex: t1.small.x86)
5	-t target    Target mount point to write configs to
9	-C path      Path to file containing cpr.sh output json
,	-D path      Path to grub.default template
(	-T path      Path to grub.cfg template

	Options:
 	-h           This help message
5	-v           Turn on verbose messages for debugging

CDescription: This script will configure grub for the target distro
'
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
	+ set -x
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ plan=c2.medium.x86
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ target=/mnt/target
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ cprout=/statedir/cpr.json
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
!+ default_path=/tmp/grub.default
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
#+ template_path=/tmp/grub.template
+ getopts p:t:C:D:T:hv OPTION
�+ assert_all_args_consumed 12 -v -p c2.medium.x86 -t /mnt/target -C /statedir/cpr.json -D /tmp/grub.default -T /tmp/grub.template
+ local index=12
+ shift
+ (( index != 11 + 1 ))
$+ grep -qs /mnt/target /proc/mounts
$+ echo 'Target is mounted... good.'
Target is mounted... good.
+ rm -rf /mnt/target/boot/grub
"+ [[ -d /mnt/target/boot/grub2 ]]
"+ mkdir -p /mnt/target/boot/grub2
'+ ln -nsfT grub2 /mnt/target/boot/grub
&++ jq -r .rootuuid /statedir/cpr.json
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
0+ [[ -n 0d83961f-5b01-4775-888c-8095432d9e46 ]]
S+ sed s/PACKET_ROOT_UUID/0d83961f-5b01-4775-888c-8095432d9e46/g /tmp/grub.template
F++ sed -nr 's|GRUB_CMDLINE_LINUX='\''(.*)'\''|\1|p' /tmp/grub.default
L+ cmdline='console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
aDetected cmdline: console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1
s+ echo -e '\033[0;33;5;7mDetected cmdline: console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1\033[0m'
*+ sed -i 's|^|export |' /tmp/grub.default
+ source /tmp/grub.default
_++ export 'GRUB_CMDLINE_LINUX=console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
X++ GRUB_CMDLINE_LINUX='console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
]++ export 'GRUB_SERIAL_COMMAND=serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1'
V++ GRUB_SERIAL_COMMAND='serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1'
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
++ awk '{print $1}'
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ GRUB_DISTRIBUTOR=Ubuntu

 + envsubst

+ is_uefi
+ [[ -d /sys/firmware/efi ]]

 + uefi=true

 ++ uname -m
+ arch=x86_64
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ os_ver='Ubuntu 18.04'
+ set -- Ubuntu 18.04
+ DOS=Ubuntu
+ DVER=18.04
/#### Detected OS on mounted target /mnt/target
$OS: Ubuntu  ARCH: x86_64 VER: 18.04
8+ echo '#### Detected OS on mounted target /mnt/target'
-+ echo 'OS: Ubuntu  ARCH: x86_64 VER: 18.04'
+ chroot_install=false
?+ [[ Ubuntu == \R\e\d\H\a\t\E\n\t\e\r\p\r\i\s\e\S\e\r\v\e\r ]]
4+ [[ c2.medium.x86 == \c\3\.\m\e\d\i\u\m\.\x\8\6 ]]
*++ jq -r '.bootdevs[]' /statedir/cpr.json
+ bootdevs=/dev/sdd
+ [[ -n /dev/sdd ]]
+ for disk in '$bootdevs'
+ false
+ install_grub_osie
*+ echo 'Running grub-install on /dev/sdd'
+ true
+ [[ x86_64 == aarch64 ]]
!Running grub-install on /dev/sdd
p+ grub-install --recheck --bootloader-id=GRUB --root-directory=/mnt/target --efi-directory=/mnt/target/boot/efi
$Installing for x86_64-efi platform.
*Installation finished. No error reported.
<++ find /mnt/target/boot/efi -name 'grub*.efi' -print -quit
4+ grubefi=/mnt/target/boot/efi/EFI/GRUB/grubx64.efi
5+ [[ -z /mnt/target/boot/efi/EFI/GRUB/grubx64.efi ]]
+ [[ x86_64 == aarch64 ]]
+ efibootmgr
+ tee /dev/stderr
+ grep -iq grub
BootCurrent: 0000
BootOrder: 0004,0000
Boot0000* NIC in Slot 2 Port 1
Boot0001* Hard drive C:
*Boot0002* FlexBoot v3.5.403 (PCI 05:00.0)
*Boot0003* FlexBoot v3.5.403 (PCI 05:00.1)
Boot0004* GRUB
&++ jq -r .rootuuid /statedir/cpr.json
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
0+ [[ -n 0d83961f-5b01-4775-888c-8095432d9e46 ]]
F++ sed -nr 's|GRUB_CMDLINE_LINUX='\''(.*)'\''|\1|p' /tmp/grub.default
S+ cmdline='export console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
+ cat
H+ echo -e '\033[0;32m#### Clearing init overrides to enable TTY\033[0m'
6#### Clearing init overrides to enable TTY
++ rm -rf '/mnt/target/etc/init/*.override'
+ [[ false == false ]]
;+ echo -e '\033[0;32m#### Setting up package repos\033[0m'
)#### Setting up package repos
;+ ./repos.sh -a x86_64 -t /mnt/target -f ewr1 -M /metadata
*+ USAGE='Usage: ./repos.sh -t /mnt/target
Required Arguments:
2	-a arch     System architecture {aarch64|x86_64}
/	-M metadata File containing instance metadata
2	-t target   Target mount point to write repos to

	Options:
7	-f facility Facility to use to reach artifacts server
z	-m url      Address to embed into OS for package repository (advanced usage, default http://mirror.$facility.packet.net)
	-h          This help message
4	-v          Turn on verbose messages for debugging

|Description: This script will configure the package repositories based upon LSB properties located on a target mount point.
'
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ arch=x86_64
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ export TARGET=/mnt/target
+ TARGET=/mnt/target
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ facility=ewr1
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ metadata=/metadata
+ getopts a:M:t:f:m:hv OPTION
$+ check_required_arg x86_64 arch -a
+ arg=x86_64

 + name=arch

 + switch=-a
+ [[ -n x86_64 ]]

 + return 0
2+ check_required_arg /metadata 'metadata file' -M
+ arg=/metadata
+ name='metadata file'

 + switch=-M
+ [[ -n /metadata ]]

 + return 0
9+ check_required_arg /mnt/target 'target mount point' -t
+ arg=/mnt/target
+ name='target mount point'

 + switch=-t
+ [[ -n /mnt/target ]]

 + return 0
K+ assert_all_args_consumed 9 -a x86_64 -t /mnt/target -f ewr1 -M /metadata
+ local index=9
+ shift
+ (( index != 8 + 1 ))
'+ mirror=http://mirror.ewr1.packet.net
$+ grep -qs /mnt/target /proc/mounts
$+ echo 'Target is mounted... good.'
Target is mounted... good.
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ os_ver='Ubuntu 18.04'
+ set -- Ubuntu 18.04
+ DOS=Ubuntu
+ DVER=18.04
8+ echo '#### Detected OS on mounted target /mnt/target'
-+ echo 'OS: Ubuntu  ARCH: x86_64 VER: 18.04'
/#### Detected OS on mounted target /mnt/target
$OS: Ubuntu  ARCH: x86_64 VER: 18.04
+ case "$DOS" in

 + do_ubuntu
+ case "$DVER" in
+ do_ubuntu_18_04_x86_64
,+ echo 'Configuring repos for Ubuntu 18.04'
#Configuring repos for Ubuntu 18.04
+ cat
	+ exit 0
D+ echo -e '\033[0;32m#### Configuring cloud-init for Packet\033[0m'
-+ '[' -f /mnt/target/etc/cloud/cloud.cfg ']'
2#### Configuring cloud-init for Packet
+ case ${OS} in
+ repo_module=apt-configure
+ cat
K+ echo 'Disabling cloud-init based network config via cloud.cfg.d include'
%+ echo 'network: {config: disabled}'
BDisabling cloud-init based network config via cloud.cfg.d include
#WARNING: Removing /var/lib/cloud/*
,+ echo 'WARNING: Removing /var/lib/cloud/*'
'+ rm -rf '/mnt/target/var/lib/cloud/*'
;+ '[' -f /mnt/target/etc/cloud/cloud.cfg.d/90_dpkg.cfg ']'
+ cat
8+ '[' -f /mnt/target/etc/init/cloud-init-nonet.conf ']'
ICloud-init post-install - cloud-init-nonet does not exist. skipping edit
R+ echo 'Cloud-init post-install - cloud-init-nonet does not exist. skipping edit'
.+ [[ -f /mnt/target/etc/init/failsafe.conf ]]
+ mkdir /home/packet
_+ wget http://192.168.1.2/misc/osie/current/github/packet-block-storage-attach -P /home/packet
a--2020-02-11 04:46:39--  http://192.168.1.2/misc/osie/current/github/packet-block-storage-attach
+Connecting to 192.168.1.2:80... connected.
6HTTP request sent, awaiting response... 404 Not Found
*2020-02-11 04:46:39 ERROR 404: Not Found.

Creating new GPT entries.
Setting name!
partNum is 0
REALLY setting name!
*The operation has completed successfully.
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[1].label'
9++ jq -r '.disks[0].partitions[1].label' /tmp/config.cpr
+ partlabel=SWAP
,++ stormeta 'disks[0].partitions[1].number'
:++ jq -r '.disks[0].partitions[1].number' /tmp/config.cpr

 + partnum=2
*++ stormeta 'disks[0].partitions[1].size'
8++ jq -r '.disks[0].partitions[1].size' /tmp/config.cpr
+ partsize=3993600
+ parttype=8300
D+ msg 'Working on /dev/sdd part 2 aka label SWAP with size 3993600'
R+ echo -e 'Working on /dev/sdd part 2 aka label SWAP with size 3993600' '\033[0m'
AWorking on /dev/sdd part 2 aka label SWAP with size 3993600 
+ [[ SWAP =~ BIOS ]]
+ [[ 3993600 =~ pct ]]
+ (( partsize == 0 ))
+ partsize=+3993600
6+ sgdisk -n 2:0:+3993600 -c 2:SWAP -t 2:8300 /dev/sdd
Setting name!
partNum is 1
REALLY setting name!
*The operation has completed successfully.
2+ for partcnt in '$(seq 0 $((${#parts[@]} - 1)))'
+++ stormeta 'disks[0].partitions[2].label'
9++ jq -r '.disks[0].partitions[2].label' /tmp/config.cpr
+ partlabel=ROOT
,++ stormeta 'disks[0].partitions[2].number'
:++ jq -r '.disks[0].partitions[2].number' /tmp/config.cpr

 + partnum=3
*++ stormeta 'disks[0].partitions[2].size'
8++ jq -r '.disks[0].partitions[2].size' /tmp/config.cpr
+ partsize=0
+ parttype=8300
>+ msg 'Working on /dev/sdd part 3 aka label ROOT with size 0'
L+ echo -e 'Working on /dev/sdd part 3 aka label ROOT with size 0' '\033[0m'
;Working on /dev/sdd part 3 aka label ROOT with size 0 
+ [[ ROOT =~ BIOS ]]
+ [[ 0 =~ pct ]]
+ (( partsize == 0 ))
?+ msg 'Partsize is zero. This means use the rest of the disk.'
M+ echo -e 'Partsize is zero. This means use the rest of the disk.' '\033[0m'
<Partsize is zero. This means use the rest of the disk. 
/+ sgdisk -n 3:0:0 -c 3:ROOT -t 3:8300 /dev/sdd
Setting name!
partNum is 2
REALLY setting name!
*The operation has completed successfully.

 + diskcnt=1

 + raidcnt=0
+ for raid in '"${raids[@]}"'
+ [[ hack == \h\a\c\k ]]
+ break

+ fscnt=0
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd1'
7+ echo -e 'Writing filesystem for /dev/sdd1' '\033[0m'
&Writing filesystem for /dev/sdd1 
*++ stormeta 'filesystems[0].mount.format'
8++ jq -r '.filesystems[0].mount.format' /tmp/config.cpr
+ format=vfat
)++ stormeta 'filesystems[0].mount.point'
7++ jq -r '.filesystems[0].mount.point' /tmp/config.cpr
+ mpoint=/boot/efi
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[0].mount.create.options[]'
B++ jq -r '.filesystems[0].mount.create.options[]' /tmp/config.cpr

+ fscnt=1
E+ msg '/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi"'
S+ echo -e '/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi"' '\033[0m'
B/dev/sdd1: format=vfat fsopts="32 -n EFI" mpoint="/boot/efi" 
+ [[ vfat == \b\i\o\s ]]
+ [[ vfat == \s\w\a\p ]]
#+ mkfs.vfat -F 32 -n EFI /dev/sdd1
mkfs.fat 3.0.28 (2015-05-16)
$++ blkid -s UUID -o value /dev/sdd1
+ thisdevuuid=192C-BA9E
+ [[ /boot/efi == / ]]
(+ add_to_fstab 192C-BA9E /boot/efi vfat
[+ local UUID=192C-BA9E MOUNTPOINT=/boot/efi FSFORMAT=vfat options=errors=remount-ro fsck=2
%+ grep -qs 192C-BA9E /tmp/fstab.tmpl
+ [[ vfat == swap ]]
+ [[ /boot/efi == \/ ]]
E+ echo -e 'UUID=192C-BA9E\t/boot/efi\tvfat\terrors=remount-ro\t0\t2'
+ tee -a /tmp/fstab.tmpl
4UUID=192C-BA9E	/boot/efi	vfat	errors=remount-ro	0	2
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd3'
7+ echo -e 'Writing filesystem for /dev/sdd3' '\033[0m'
&Writing filesystem for /dev/sdd3 
*++ stormeta 'filesystems[1].mount.format'
8++ jq -r '.filesystems[1].mount.format' /tmp/config.cpr
+ format=ext4
)++ stormeta 'filesystems[1].mount.point'
7++ jq -r '.filesystems[1].mount.point' /tmp/config.cpr

 + mpoint=/
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[1].mount.create.options[]'
B++ jq -r '.filesystems[1].mount.create.options[]' /tmp/config.cpr

+ fscnt=2
;+ msg '/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/"'
I+ echo -e '/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/"' '\033[0m'
8/dev/sdd3: format=ext4 fsopts="-L ROOT" mpoint="/" 
+ [[ ext4 == \b\i\o\s ]]
+ [[ ext4 == \s\w\a\p ]]
!+ mkfs.ext4 -F -L ROOT /dev/sdd3
mke2fs 1.42.13 (17-May-2015)
[Discarding device blocks: done                            
?Creating filesystem with 28674673 4k blocks and 7176192 inodes
6Filesystem UUID: 0d83961f-5b01-4775-888c-8095432d9e46
&Superblock backups stored on blocks: 
J	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
0	4096000, 7962624, 11239424, 20480000, 23887872

VAllocating group tables: done                            
SWriting inode tables: done                            
&Creating journal (32768 blocks): done
\Writing superblocks and filesystem accounting information: done   

$++ blkid -s UUID -o value /dev/sdd3
3+ thisdevuuid=0d83961f-5b01-4775-888c-8095432d9e46
+ [[ / == / ]]
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
;+ add_to_fstab 0d83961f-5b01-4775-888c-8095432d9e46 / ext4
n+ local UUID=0d83961f-5b01-4775-888c-8095432d9e46 MOUNTPOINT=/ FSFORMAT=ext4 options=errors=remount-ro fsck=2
@+ grep -qs 0d83961f-5b01-4775-888c-8095432d9e46 /tmp/fstab.tmpl
+ [[ ext4 == swap ]]
+ [[ / == \/ ]]
	+ fsck=1
X+ echo -e 'UUID=0d83961f-5b01-4775-888c-8095432d9e46\t/\text4\terrors=remount-ro\t0\t1'
+ tee -a /tmp/fstab.tmpl
GUUID=0d83961f-5b01-4775-888c-8095432d9e46	/	ext4	errors=remount-ro	0	1
 + for fsdev in '"${fsdevs[@]}"'
)+ msg 'Writing filesystem for /dev/sdd2'
7+ echo -e 'Writing filesystem for /dev/sdd2' '\033[0m'
&Writing filesystem for /dev/sdd2 
*++ stormeta 'filesystems[2].mount.format'
8++ jq -r '.filesystems[2].mount.format' /tmp/config.cpr
+ format=swap
)++ stormeta 'filesystems[2].mount.point'
7++ jq -r '.filesystems[2].mount.point' /tmp/config.cpr
+ mpoint=none
D+ fsopts=($(stormeta "filesystems[$fscnt].mount.create.options[]"))
4++ stormeta 'filesystems[2].mount.create.options[]'
B++ jq -r '.filesystems[2].mount.create.options[]' /tmp/config.cpr

+ fscnt=3
>+ msg '/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none"'
L+ echo -e '/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none"' '\033[0m'
;/dev/sdd2: format=swap fsopts="-L SWAP" mpoint="none" 
+ [[ swap == \b\i\o\s ]]
+ [[ swap == \s\w\a\p ]]
+ mkswap /dev/sdd2
7mkswap: /dev/sdd2: warning: wiping old swap signature.
BSetting up swapspace version 1, size = 1.9 GiB (2044719104 bytes)
4no label, UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b
{"level":"info","msg":"Container removed with Status  ACTION_FAILED","time":"2020-02-11T04:46:47Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"level":"info","msg":"Wait finished for failed or timeout container","time":"2020-02-11T04:46:47Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
$++ blkid -s UUID -o value /dev/sdd2
3+ thisdevuuid=63caa65d-cf33-45d9-81e5-58f9e36f789b
+ [[ none == / ]]
>+ add_to_fstab 63caa65d-cf33-45d9-81e5-58f9e36f789b none swap
q+ local UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b MOUNTPOINT=none FSFORMAT=swap options=errors=remount-ro fsck=2
@+ grep -qs 63caa65d-cf33-45d9-81e5-58f9e36f789b /tmp/fstab.tmpl
+ [[ swap == swap ]]
	+ fsck=0
+ options=none
+ [[ none == \/ ]]
N+ echo -e 'UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b\tnone\tswap\tnone\t0\t0'
+ tee -a /tmp/fstab.tmpl
=UUID=63caa65d-cf33-45d9-81e5-58f9e36f789b	none	swap	none	0	0
+ cat

+ python3
&{"bootdevs": ["/dev/sdd"], "fstab": "UUID=192C-BA9E\t/boot/efi\tvfat\terrors=remount-ro\t0\t2\nUUID=0d83961f-5b01-4775-888c-8095432d9e46\t/\text4\terrors=remount-ro\t0\t1\nUUID=63caa65d-cf33-45d9-81e5-58f9e36f789b\tnone\tswap\tnone\t0\t0\n", "rootuuid": "0d83961f-5b01-4775-888c-8095432d9e46"}
D+ msg '\033[0;32m#### Mounting filesystems in fstab to /mnt/target'
R+ echo -e '\033[0;32m#### Mounting filesystems in fstab to /mnt/target' '\033[0m'
>#### Mounting filesystems in fstab to /mnt/target 
9+ sed -i 's|\(\S\)\t/|\1\t/mnt/target/|' /tmp/fstab.tmpl
+ read -r mnt
.++ awk '/\/mnt\// {print $2}' /tmp/fstab.tmpl
++ sort
+ mkdir -p /mnt/target/
-+ mount --fstab /tmp/fstab.tmpl /mnt/target/
+ read -r mnt
 + mkdir -p /mnt/target/boot/efi
5+ mount --fstab /tmp/fstab.tmpl /mnt/target/boot/efi
+ read -r mnt
+ mount
+ grep /mnt/target
7tmpfs on /mnt/target type tmpfs (rw,relatime,mode=755)
@tmpfs on /mnt/target/boot/efi type tmpfs (rw,relatime,mode=755)
P/dev/sdd3 on /mnt/target type ext4 (rw,relatime,errors=remount-ro,data=ordered)
�/dev/sdd1 on /mnt/target/boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=utf8,shortname=mixed,errors=remount-ro)
a+ echo -e '\033[0;32m#### Retrieving image archive and installing to target /mnt/target \033[0m'
O#### Retrieving image archive and installing to target /mnt/target 
�+ tar --xattrs --acls --selinux --numeric-owner --same-owner --warning=no-timestamp -zxpf /tmp/assets/image.tar.gz -C /mnt/target
"+ jq -r .fstab /statedir/cpr.json
<+ mkdir -p /mnt/target/dev /mnt/target/proc /mnt/target/sys
!+ mkdir -p /mnt/target/etc/mdadm
2+ [[ c2.medium.x86 != \t\1\.\s\m\a\l\l\.\x\8\6 ]]
@+ echo -e '\033[0;32m#### Updating MD RAID config file \033[0m'
+ mdadm --examine --scan
.#### Updating MD RAID config file 
5+ echo -e '\033[0;32m#### Setting machine-id\033[0m'
G+ rm -f /mnt/target/etc/machine-id /mnt/target/var/lib/dbus/machine-id
##### Setting machine-id
.+ systemd-machine-id-setup --root=/mnt/target
/Initializing machine ID from random generator.
!+ cat /mnt/target/etc/machine-id
!64d2b4236a4f4c2cbdcdc1d5d689e28d
$+ [[ -d /mnt/target/var/lib/dbus ]]
>+ ln -nsf /etc/machine-id /mnt/target/var/lib/dbus/machine-id
]+ echo -e '\033[0;32m#### Copying kernel, modules, and initrd to target /mnt/target \033[0m'
K#### Copying kernel, modules, and initrd to target /mnt/target 
P+ tar --warning=no-timestamp -zxf /tmp/assets/kernel.tar.gz -C /mnt/target/boot
,++ vmlinuz_version /mnt/target/boot/vmlinuz
)++ local kernel=/mnt/target/boot/vmlinuz
++ set +o pipefail
%+++ file -b /mnt/target/boot/vmlinuz
�++ type='Linux kernel x86 boot executable bzImage, version 4.15.0-50-generic (buildd@lcy01-amd64-013) #54-Ubuntu SMP Mon M, RO-rootFS, swap_dev 0x7, Normal VGA'
++ case "$type" in
!++ echo 'kernel is type bzImage'
kernel is type bzImage
�++ echo 'Linux kernel x86 boot executable bzImage, version 4.15.0-50-generic (buildd@lcy01-amd64-013) #54-Ubuntu SMP Mon M, RO-rootFS, swap_dev 0x7, Normal VGA'
'++ sed 's|.*, version \(\S\+\) .*|\1|'
++ set -o pipefail
+ kversion=4.15.0-50-generic
+ [[ -z 4.15.0-50-generic ]]
'+ kernelname=vmlinuz-4.15.0-50-generic
 + [[ ubuntu_18_04 =~ ^centos ]]
+ [[ ubuntu_18_04 =~ ^rhel ]]
*+ initrdname=initrd.img-4.15.0-50-generic
+ modulesdest=
I+ mv /mnt/target/boot/vmlinuz /mnt/target/boot/vmlinuz-4.15.0-50-generic
=+ ln -nsf vmlinuz-4.15.0-50-generic /mnt/target/boot/vmlinuz
<+ tar --warning=no-timestamp -zxf /tmp/assets/initrd.tar.gz
:+ mv initrd /mnt/target/boot/initrd.img-4.15.0-50-generic
?+ ln -nsf initrd.img-4.15.0-50-generic /mnt/target/boot/initrd
M+ tar --warning=no-timestamp -zxf /tmp/assets/modules.tar.gz -C /mnt/target/
A+ cp /mnt/target/boot/vmlinuz-4.15.0-50-generic /statedir/kernel
D+ cp /mnt/target/boot/initrd.img-4.15.0-50-generic /statedir/initrd
3+ echo -e '\033[0;32m#### Installing GRUB2\033[0m'
p+ wget http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template -O /tmp/grub.template
!#### Installing GRUB2
l--2020-02-11 04:46:36--  http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template
+Connecting to 192.168.1.2:80... connected.
/HTTP request sent, awaiting response... 200 OK
/Length: 2202 (2.2K) [application/octet-stream]
 Saving to: '/tmp/grub.template'

L     0K ..                                                    100% 37.0M=0s

I2020-02-11 04:46:36 (37.0 MB/s) - '/tmp/grub.template' saved [2202/2202]
{"level":"error","msg":"Failed to remove container as  Error: No such container: 4c1bdbb318001ddbd848b50f761f95786e40e7f0e3f0bd6b951f4b54b7c18b45","time":"2020-02-11T04:46:47Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"level":"info","msg":"Action container exits with status code  ACTION_FAILED","time":"2020-02-11T04:46:47Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}
{"Task":"os-installation","action":"fetch-assets","level":"error","msg":"Action Failed","time":"2020-02-11T04:46:47Z","worker_id":"fde7c87c-d154-447e-9fce-7eb7bdec90c0","workflow_id":"86cf7b44-8abf-41a3-bdd6-3c53a5aa5f91"}

w+ wget http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template.default -O /tmp/grub.default
t--2020-02-11 04:46:36--  http://192.168.1.2/misc/osie/current/grub/ubuntu_18_04/c2.medium.x86/grub.template.default
+Connecting to 192.168.1.2:80... connected.
/HTTP request sent, awaiting response... 200 OK
'Length: 168 [application/octet-stream]
Saving to: '/tmp/grub.default'

L     0K                                                       100% 50.6M=0s

F2020-02-11 04:46:36 (50.6 MB/s) - '/tmp/grub.default' saved [168/168]

7+ mount -t efivarfs efivarfs /sys/firmware/efi/efivars
+ mount
8overlay on / type overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/KMKKN2TTVKYT5PX3QA6QP3XZ4M:/var/lib/docker/overlay2/l/3S2PKK6NOM7P4LOPBMZFG6OXIT:/var/lib/docker/overlay2/l/Z7N5WJEUPG3OVGVX56Z63EG2HK:/var/lib/docker/overlay2/l/H3M44XER4QBHKQ7MEHMFVRY7DI:/var/lib/docker/overlay2/l/XF7HTATY6YRE5OOF54XN2IFLYS:/var/lib/docker/overlay2/l/BQMA6NCC26ADZZDRUZUBZZNT5Z:/var/lib/docker/overlay2/l/KORFEDBTJENL4TNAUMYREYFMGB:/var/lib/docker/overlay2/l/P4ZPV6PO5FHALMEOIZXL3AIJZW:/var/lib/docker/overlay2/l/YIS3FL7WONPD3JGP66SMTKB2XD:/var/lib/docker/overlay2/l/AVHX4WGTWODU4NEYJJSA5DRGQL:/var/lib/docker/overlay2/l/KGPN6SGQZ4M3BJCRY7RKSMTRZO:/var/lib/docker/overlay2/l/BBYKXHCY7TD4XDNTRZJPTBT6TK:/var/lib/docker/overlay2/l/2ARNEQ7QLNPA25EGOZH7O5H7BO:/var/lib/docker/overlay2/l/WZDUGLWPKO47DQUCXVZZFRVSEW:/var/lib/docker/overlay2/l/LVEBUE66F3BCHY7WWH7VJUQ6YH:/var/lib/docker/overlay2/l/6VYQU42IYZPDBEN7IQURX4WYDI:/var/lib/docker/overlay2/l/6UYOO2UW47DURTYFZ7KXYKEQQX:/var/lib/docker/overlay2/l/LROHBLGGR636TSAPN5GQMNFIKE:/var/lib/docker/overlay2/l/3JUDEU5QN6S4SPI2LPANNTUC5L:/var/lib/docker/overlay2/l/U2PMHQGRASO7BNMGTJLHACHWM4,upperdir=/var/lib/docker/overlay2/fcc6fc7ad84d0ea091ae33da5a7a34483e2d4047f244d73eba7fb3f1037ec4e3/diff,workdir=/var/lib/docker/overlay2/fcc6fc7ad84d0ea091ae33da5a7a34483e2d4047f244d73eba7fb3f1037ec4e3/work)
:proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
;sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
Ntmpfs on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,mode=755)
�openrc on /sys/fs/cgroup/openrc type cgroup (rw,nosuid,nodev,noexec,relatime,release_agent=/lib/rc/sh/cgroup-release-agent.sh,name=openrc)
Ucpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
Lcpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)
Xcpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)
Rblkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
Umemory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
Xdevices on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
Xfreezer on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
Xnet_cls on /sys/fs/cgroup/net_cls type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls)
[net_prio on /sys/fs/cgroup/net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio)
Opids on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
3tmpfs on /worker type tmpfs (rw,relatime,mode=755)
0tmpfs on /mnt type tmpfs (rw,relatime,mode=755)
[devtmpfs on /dev type devtmpfs (rw,nosuid,relatime,size=10240k,nr_inodes=8194836,mode=755)
Wdevpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
=shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime)
Dmqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)
5tmpfs on /statedir type tmpfs (rw,relatime,mode=755)
5tmpfs on /workflow type tmpfs (rw,relatime,mode=755)
7tmpfs on /mnt/target type tmpfs (rw,relatime,mode=755)
7tmpfs on /tmp/assets type tmpfs (rw,relatime,mode=755)
cdevtmpfs on /dev/console type devtmpfs (rw,nosuid,relatime,size=10240k,nr_inodes=8194836,mode=755)
A/lib/modloop-x86_64 on /lib/firmware type squashfs (ro,relatime)
6tmpfs on /etc/hosts type tmpfs (rw,relatime,mode=755)
<tmpfs on /etc/resolv.conf type tmpfs (rw,relatime,mode=755)
9tmpfs on /etc/hostname type tmpfs (rw,relatime,mode=755)
Ishm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=65536k)
@tmpfs on /mnt/target/boot/efi type tmpfs (rw,relatime,mode=755)
P/dev/sdd3 on /mnt/target type ext4 (rw,relatime,errors=remount-ro,data=ordered)
�/dev/sdd1 on /mnt/target/boot/efi type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=utf8,shortname=mixed,errors=remount-ro)
Befivarfs on /sys/firmware/efi/efivars type efivarfs (rw,relatime)
z+ ./grub-installer.sh -v -p c2.medium.x86 -t /mnt/target -C /statedir/cpr.json -D /tmp/grub.default -T /tmp/grub.template
K+ USAGE='Usage: ./grub-installer.sh -t /mnt/target -C /path/to/cprout.json
Required Arguments:
-	-p plan      Server plan (ex: t1.small.x86)
5	-t target    Target mount point to write configs to
9	-C path      Path to file containing cpr.sh output json
,	-D path      Path to grub.default template
(	-T path      Path to grub.cfg template

	Options:
 	-h           This help message
5	-v           Turn on verbose messages for debugging

CDescription: This script will configure grub for the target distro
'
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
	+ set -x
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ plan=c2.medium.x86
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ target=/mnt/target
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
+ cprout=/statedir/cpr.json
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
!+ default_path=/tmp/grub.default
+ getopts p:t:C:D:T:hv OPTION
+ case $OPTION in
#+ template_path=/tmp/grub.template
+ getopts p:t:C:D:T:hv OPTION
�+ assert_all_args_consumed 12 -v -p c2.medium.x86 -t /mnt/target -C /statedir/cpr.json -D /tmp/grub.default -T /tmp/grub.template
+ local index=12
+ shift
+ (( index != 11 + 1 ))
$+ grep -qs /mnt/target /proc/mounts
$+ echo 'Target is mounted... good.'
Target is mounted... good.
+ rm -rf /mnt/target/boot/grub
"+ [[ -d /mnt/target/boot/grub2 ]]
"+ mkdir -p /mnt/target/boot/grub2
'+ ln -nsfT grub2 /mnt/target/boot/grub
&++ jq -r .rootuuid /statedir/cpr.json
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
0+ [[ -n 0d83961f-5b01-4775-888c-8095432d9e46 ]]
S+ sed s/PACKET_ROOT_UUID/0d83961f-5b01-4775-888c-8095432d9e46/g /tmp/grub.template
F++ sed -nr 's|GRUB_CMDLINE_LINUX='\''(.*)'\''|\1|p' /tmp/grub.default
L+ cmdline='console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
aDetected cmdline: console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1
s+ echo -e '\033[0;33;5;7mDetected cmdline: console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1\033[0m'
*+ sed -i 's|^|export |' /tmp/grub.default
+ source /tmp/grub.default
_++ export 'GRUB_CMDLINE_LINUX=console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
X++ GRUB_CMDLINE_LINUX='console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
]++ export 'GRUB_SERIAL_COMMAND=serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1'
V++ GRUB_SERIAL_COMMAND='serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1'
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
++ awk '{print $1}'
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ GRUB_DISTRIBUTOR=Ubuntu

 + envsubst

+ is_uefi
+ [[ -d /sys/firmware/efi ]]

 + uefi=true

 ++ uname -m
+ arch=x86_64
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ os_ver='Ubuntu 18.04'
+ set -- Ubuntu 18.04
+ DOS=Ubuntu
+ DVER=18.04
/#### Detected OS on mounted target /mnt/target
$OS: Ubuntu  ARCH: x86_64 VER: 18.04
8+ echo '#### Detected OS on mounted target /mnt/target'
-+ echo 'OS: Ubuntu  ARCH: x86_64 VER: 18.04'
+ chroot_install=false
?+ [[ Ubuntu == \R\e\d\H\a\t\E\n\t\e\r\p\r\i\s\e\S\e\r\v\e\r ]]
4+ [[ c2.medium.x86 == \c\3\.\m\e\d\i\u\m\.\x\8\6 ]]
*++ jq -r '.bootdevs[]' /statedir/cpr.json
+ bootdevs=/dev/sdd
+ [[ -n /dev/sdd ]]
+ for disk in '$bootdevs'
+ false
+ install_grub_osie
*+ echo 'Running grub-install on /dev/sdd'
+ true
+ [[ x86_64 == aarch64 ]]
!Running grub-install on /dev/sdd
p+ grub-install --recheck --bootloader-id=GRUB --root-directory=/mnt/target --efi-directory=/mnt/target/boot/efi
$Installing for x86_64-efi platform.
*Installation finished. No error reported.
<++ find /mnt/target/boot/efi -name 'grub*.efi' -print -quit
4+ grubefi=/mnt/target/boot/efi/EFI/GRUB/grubx64.efi
5+ [[ -z /mnt/target/boot/efi/EFI/GRUB/grubx64.efi ]]
+ [[ x86_64 == aarch64 ]]
+ efibootmgr
+ tee /dev/stderr
+ grep -iq grub
BootCurrent: 0000
BootOrder: 0004,0000
Boot0000* NIC in Slot 2 Port 1
Boot0001* Hard drive C:
*Boot0002* FlexBoot v3.5.403 (PCI 05:00.0)
*Boot0003* FlexBoot v3.5.403 (PCI 05:00.1)
Boot0004* GRUB
&++ jq -r .rootuuid /statedir/cpr.json
0+ rootuuid=0d83961f-5b01-4775-888c-8095432d9e46
0+ [[ -n 0d83961f-5b01-4775-888c-8095432d9e46 ]]
F++ sed -nr 's|GRUB_CMDLINE_LINUX='\''(.*)'\''|\1|p' /tmp/grub.default
S+ cmdline='export console=tty0 console=ttyS1,115200n8 biosdevname=0 net.ifnames=1'
+ cat
H+ echo -e '\033[0;32m#### Clearing init overrides to enable TTY\033[0m'
6#### Clearing init overrides to enable TTY
++ rm -rf '/mnt/target/etc/init/*.override'
+ [[ false == false ]]
;+ echo -e '\033[0;32m#### Setting up package repos\033[0m'
)#### Setting up package repos
;+ ./repos.sh -a x86_64 -t /mnt/target -f ewr1 -M /metadata
*+ USAGE='Usage: ./repos.sh -t /mnt/target
Required Arguments:
2	-a arch     System architecture {aarch64|x86_64}
/	-M metadata File containing instance metadata
2	-t target   Target mount point to write repos to

	Options:
7	-f facility Facility to use to reach artifacts server
z	-m url      Address to embed into OS for package repository (advanced usage, default http://mirror.$facility.packet.net)
	-h          This help message
4	-v          Turn on verbose messages for debugging

|Description: This script will configure the package repositories based upon LSB properties located on a target mount point.
'
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ arch=x86_64
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ export TARGET=/mnt/target
+ TARGET=/mnt/target
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ facility=ewr1
+ getopts a:M:t:f:m:hv OPTION
+ case $OPTION in
+ metadata=/metadata
+ getopts a:M:t:f:m:hv OPTION
$+ check_required_arg x86_64 arch -a
+ arg=x86_64

 + name=arch

 + switch=-a
+ [[ -n x86_64 ]]

 + return 0
2+ check_required_arg /metadata 'metadata file' -M
+ arg=/metadata
+ name='metadata file'

 + switch=-M
+ [[ -n /metadata ]]

 + return 0
9+ check_required_arg /mnt/target 'target mount point' -t
+ arg=/mnt/target
+ name='target mount point'

 + switch=-t
+ [[ -n /mnt/target ]]

 + return 0
K+ assert_all_args_consumed 9 -a x86_64 -t /mnt/target -f ewr1 -M /metadata
+ local index=9
+ shift
+ (( index != 8 + 1 ))
'+ mirror=http://mirror.ewr1.packet.net
$+ grep -qs /mnt/target /proc/mounts
$+ echo 'Target is mounted... good.'
Target is mounted... good.
++ detect_os /mnt/target
++ local rootdir os version
++ rootdir=/mnt/target
'+++ chroot /mnt/target lsb_release -si
+++ sed 's/ //g'
++ os=Ubuntu
'+++ chroot /mnt/target lsb_release -sr
++ version=18.04
++ [[ -n Ubuntu ]]
++ [[ -n 18.04 ]]
++ echo 'Ubuntu 18.04'

++ return
+ os_ver='Ubuntu 18.04'
+ set -- Ubuntu 18.04
+ DOS=Ubuntu
+ DVER=18.04
8+ echo '#### Detected OS on mounted target /mnt/target'
-+ echo 'OS: Ubuntu  ARCH: x86_64 VER: 18.04'
/#### Detected OS on mounted target /mnt/target
$OS: Ubuntu  ARCH: x86_64 VER: 18.04
+ case "$DOS" in

 + do_ubuntu
+ case "$DVER" in
+ do_ubuntu_18_04_x86_64
,+ echo 'Configuring repos for Ubuntu 18.04'
#Configuring repos for Ubuntu 18.04
+ cat
	+ exit 0
D+ echo -e '\033[0;32m#### Configuring cloud-init for Packet\033[0m'
-+ '[' -f /mnt/target/etc/cloud/cloud.cfg ']'
2#### Configuring cloud-init for Packet
+ case ${OS} in
+ repo_module=apt-configure
+ cat
K+ echo 'Disabling cloud-init based network config via cloud.cfg.d include'
%+ echo 'network: {config: disabled}'
BDisabling cloud-init based network config via cloud.cfg.d include
#WARNING: Removing /var/lib/cloud/*
,+ echo 'WARNING: Removing /var/lib/cloud/*'
'+ rm -rf '/mnt/target/var/lib/cloud/*'
;+ '[' -f /mnt/target/etc/cloud/cloud.cfg.d/90_dpkg.cfg ']'
+ cat
8+ '[' -f /mnt/target/etc/init/cloud-init-nonet.conf ']'
ICloud-init post-install - cloud-init-nonet does not exist. skipping edit
R+ echo 'Cloud-init post-install - cloud-init-nonet does not exist. skipping edit'
.+ [[ -f /mnt/target/etc/init/failsafe.conf ]]
+ mkdir /home/packet
_+ wget http://192.168.1.2/misc/osie/current/github/packet-block-storage-attach -P /home/packet
a--2020-02-11 04:46:39--  http://192.168.1.2/misc/osie/current/github/packet-block-storage-attach
+Connecting to 192.168.1.2:80... connected.
6HTTP request sent, awaiting response... 404 Not Found
*2020-02-11 04:46:39 ERROR 404: Not Found.

